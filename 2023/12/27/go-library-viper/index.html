<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/fuchencong.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/fuchencong.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/fuchencong.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/fuchencong.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/fuchencong.github.io/css/main.css">


<link rel="stylesheet" href="/fuchencong.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fuchencong.github.io","root":"/fuchencong.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="应用程序通常都需要管理配置，这些配置可以来自命令行参数、环境变量、配置文件等等。Viper 库 是 Go 中一个经典配置管理库，为 Go 应用程序提供完整的配置解决方案。许多开源 Go 项目都使用了 Viper，例如 Hugo、Cilium 等等。这篇文章会对 Viper 库的使用做一个基本介绍。">
<meta property="og:type" content="article">
<meta property="og:title" content="go 库学习之 viper">
<meta property="og:url" content="https://fuchencong.github.io/fuchencong.github.io/2023/12/27/go-library-viper/index.html">
<meta property="og:site_name" content="fuchencong">
<meta property="og:description" content="应用程序通常都需要管理配置，这些配置可以来自命令行参数、环境变量、配置文件等等。Viper 库 是 Go 中一个经典配置管理库，为 Go 应用程序提供完整的配置解决方案。许多开源 Go 项目都使用了 Viper，例如 Hugo、Cilium 等等。这篇文章会对 Viper 库的使用做一个基本介绍。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-12-27T11:22:42.000Z">
<meta property="article:modified_time" content="2024-10-09T06:19:44.366Z">
<meta property="article:author" content="fuchencong">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://fuchencong.github.io/fuchencong.github.io/2023/12/27/go-library-viper/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>go 库学习之 viper | fuchencong</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/fuchencong.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fuchencong</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The way I am</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/fuchencong.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/fuchencong.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/fuchencong.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/fuchencong.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/fuchencong.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuchencong.github.io/fuchencong.github.io/2023/12/27/go-library-viper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/fuchencong.github.io/images/logo.jpeg">
      <meta itemprop="name" content="fuchencong">
      <meta itemprop="description" content="Having dreams is what makes life tolerable.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuchencong">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          go 库学习之 viper
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-27 19:22:42" itemprop="dateCreated datePublished" datetime="2023-12-27T19:22:42+08:00">2023-12-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/fuchencong.github.io/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>应用程序通常都需要管理配置，这些配置可以来自命令行参数、环境变量、配置文件等等。<a target="_blank" rel="noopener" href="https://github.com/spf13/viper">Viper 库</a> 是 Go 中一个经典配置管理库，为 Go 应用程序提供完整的配置解决方案。许多开源 Go 项目都使用了 Viper，例如 <code>Hugo</code>、<code>Cilium</code> 等等。这篇文章会对 Viper 库的使用做一个基本介绍。</p>
<span id="more"></span>

<h2 id="Viper-简介"><a href="#Viper-简介" class="headerlink" title="Viper 简介"></a>Viper 简介</h2><p>Viper 为 Go 应用程序（包括 <a target="_blank" rel="noopener" href="https://12factor.net/#the_twelve_factors">12-Factor apps</a>）提供完整的配置解决方案，它可以满足应用程序各种配置需求，包括：</p>
<ul>
<li>默认值设置</li>
<li>从 JSON、TOML、YAML、HCL、envfile、Java properties 格式的配置文件中读取配置</li>
<li>实时监控并重读配置文件（可选）</li>
<li>从环境变量中读取配置</li>
<li>从远端配置系统（etcd、Consul 等）读取配置，并监控变化</li>
<li>从命令行 flags 中读取配置</li>
<li>从 buffer 中读取配置</li>
<li>显式配置值</li>
</ul>
<p>在现代应用程序中，不应该关心配置文件的具体格式，只需要专注于构建软件本身即可。Viper 可以帮助你实现上述目标：</p>
<ul>
<li>查找、加载、反序列化配置文件：支持 JSON、TOML 等多种配置文件格式</li>
<li>可以为不同的配置选项提供默认值</li>
<li>支持通过命令行 flags 来覆盖配置选项的值</li>
<li>提供了别名系统，在不破坏现有代码的前提下重命名参数</li>
<li>当用户使用命令行 flags 或配置文件提供的配置值和默认值相同时，可以轻易区分出这两者</li>
</ul>
<p>Viper 按照如下优先级进行配置解析，优先级从高到低排列：</p>
<ul>
<li>显式调用 <code>Set</code> 设置值</li>
<li>flag</li>
<li>env</li>
<li>config</li>
<li>key&#x2F;value 存储</li>
<li>default</li>
</ul>
<p><strong>需要注意，Viper 配置的 key 是大小写不敏感的</strong>。</p>
<h2 id="把值存入-Viper-中"><a href="#把值存入-Viper-中" class="headerlink" title="把值存入 Viper 中"></a>把值存入 Viper 中</h2><h3 id="设置默认值"><a href="#设置默认值" class="headerlink" title="设置默认值"></a>设置默认值</h3><p>一个优秀的配置系统都会支持默认值，当用户没有显式配置某个配置项时，默认值就有用了。</p>
<p>Viper 通过如下方式设置默认值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.SetDefault(<span class="string">&quot;ContentDir&quot;</span>, <span class="string">&quot;content&quot;</span>)</span><br><span class="line">viper.SetDefault(<span class="string">&quot;LayoutDir&quot;</span>, <span class="string">&quot;layouts&quot;</span>)</span><br><span class="line">viper.SetDefault(<span class="string">&quot;Taxonomies&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;tag&quot;</span>: <span class="string">&quot;tags&quot;</span>, <span class="string">&quot;category&quot;</span>: <span class="string">&quot;categories&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="从配置文件中读取"><a href="#从配置文件中读取" class="headerlink" title="从配置文件中读取"></a>从配置文件中读取</h3><p>Viper 本身也需少量设置，这样才能知道去哪里查找配置文件。Viper 支持多种格式的配置文件，可以从多个路径中查找配置文件，但是目前单个 Viper 实例只支持单个配置文件。Viper 没有提供任何默认的 <code>配置文件搜索路径</code>，而是由应用程序自己决定。</p>
<p>如下是一个使用 Viper 查找、读取配置文件的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">viper.SetConfigName(<span class="string">&quot;config&quot;</span>) <span class="comment">// name of config file (without extension)</span></span><br><span class="line">viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>) <span class="comment">// REQUIRED if the config file does not have the extension in the name</span></span><br><span class="line">viper.AddConfigPath(<span class="string">&quot;/etc/appname/&quot;</span>)   <span class="comment">// path to look for the config file in</span></span><br><span class="line">viper.AddConfigPath(<span class="string">&quot;$HOME/.appname&quot;</span>)  <span class="comment">// call multiple times to add many search paths</span></span><br><span class="line">viper.AddConfigPath(<span class="string">&quot;.&quot;</span>)               <span class="comment">// optionally look for config in the working directory</span></span><br><span class="line">err := viper.ReadInConfig() <span class="comment">// Find and read the config file</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// Handle errors reading the config file</span></span><br><span class="line">	<span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;fatal error config file: %w&quot;</span>, err))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下特别处理了配置文件查找失败的错误：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> err := viper.ReadInConfig(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, ok := err.(viper.ConfigFileNotFoundError); ok &#123;</span><br><span class="line">		<span class="comment">// Config file not found; ignore error if desired</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Config file was found but another error was produced</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写入配置文件"><a href="#写入配置文件" class="headerlink" title="写入配置文件"></a>写入配置文件</h3><p>有时我们想保存在运行时所做的所有修改。Viper 提供了一系列接口来实现该目的：</p>
<ul>
<li>WriteConfig：将当前 viper 配置保存到预定义路径中。如果没有预定义路径则出错。会覆盖该路径下已经存在的配置文件</li>
<li>SafeWriteConfig：将当前 viper 配置保存到预定义路径中。如果没有预定义路径则出错。不会覆盖该路径下已经存在的配置文件</li>
<li>WriteConfigAs：将当前 viper 配置保存到指定路径中，会覆盖该路径下已经存在的配置文件</li>
<li>SafeWriteConfigAs：将当前 viper 配置保存到指定路径中，不会覆盖该路径下已经存在的配置文件</li>
</ul>
<p>示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">viper.WriteConfig() <span class="comment">// writes current config to predefined path set by &#x27;viper.AddConfigPath()&#x27; and &#x27;viper.SetConfigName&#x27;</span></span><br><span class="line">viper.SafeWriteConfig()</span><br><span class="line">viper.WriteConfigAs(<span class="string">&quot;/path/to/my/.config&quot;</span>)</span><br><span class="line">viper.SafeWriteConfigAs(<span class="string">&quot;/path/to/my/.config&quot;</span>) <span class="comment">// will error since it has already been written</span></span><br><span class="line">viper.SafeWriteConfigAs(<span class="string">&quot;/path/to/my/.other_config&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="监控并重新读取配置文件"><a href="#监控并重新读取配置文件" class="headerlink" title="监控并重新读取配置文件"></a>监控并重新读取配置文件</h3><p>Viper 支持让应用程序在运行时实时读取配置文件。重启服务器以让配置重新生效的日志过去了，viper 可以让应用程序在运行时读取到配置文件的更新。</p>
<p>可以让 viper 实例监听配置更新，并且指定一个回调函数，每次配置更新时都运行该函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">viper.OnConfigChange(<span class="function"><span class="keyword">func</span><span class="params">(e fsnotify.Event)</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;Config file changed:&quot;</span>, e.Name)</span><br><span class="line">&#125;)</span><br><span class="line">viper.WatchConfig()</span><br></pre></td></tr></table></figure>

<p>**在调用 <code>WatchConfig()</code> 之前需要确保所有的配置路径都已经添加了。</p>
<h3 id="从-io-Reader-中读取配置"><a href="#从-io-Reader-中读取配置" class="headerlink" title="从 io.Reader 中读取配置"></a>从 io.Reader 中读取配置</h3><p>Viper 预定义了许多配置源，例如文件、环境变量、flags、远端 KV 存储，但是不局限于这些配置源。你可以实现自己的配置源，并提供给 viper：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>) <span class="comment">// or viper.SetConfigType(&quot;YAML&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// any approach to require this configuration into your program.</span></span><br><span class="line"><span class="keyword">var</span> yamlExample = []<span class="type">byte</span>(<span class="string">`</span></span><br><span class="line"><span class="string">Hacker: true</span></span><br><span class="line"><span class="string">name: steve</span></span><br><span class="line"><span class="string">hobbies:</span></span><br><span class="line"><span class="string">- skateboarding</span></span><br><span class="line"><span class="string">- snowboarding</span></span><br><span class="line"><span class="string">- go</span></span><br><span class="line"><span class="string">clothing:</span></span><br><span class="line"><span class="string">  jacket: leather</span></span><br><span class="line"><span class="string">  trousers: denim</span></span><br><span class="line"><span class="string">age: 35</span></span><br><span class="line"><span class="string">eyes : brown</span></span><br><span class="line"><span class="string">beard: true</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line"></span><br><span class="line">viper.ReadConfig(bytes.NewBuffer(yamlExample))</span><br><span class="line"></span><br><span class="line">viper.Get(<span class="string">&quot;name&quot;</span>) <span class="comment">// this would be &quot;steve&quot;```</span></span><br></pre></td></tr></table></figure>

<h3 id="覆盖设置"><a href="#覆盖设置" class="headerlink" title="覆盖设置"></a>覆盖设置</h3><p>这些覆盖值可以来自命令行 flag，也可能来源于自己的程序逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.Set(<span class="string">&quot;Verbose&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">viper.Set(<span class="string">&quot;LogFile&quot;</span>, LogFile)</span><br><span class="line">viper.Set(<span class="string">&quot;host.port&quot;</span>, <span class="number">5899</span>)   <span class="comment">// set subset</span></span><br></pre></td></tr></table></figure>

<h3 id="注册并使用别名"><a href="#注册并使用别名" class="headerlink" title="注册并使用别名"></a>注册并使用别名</h3><p>别名可以让某个值通过多个 key 引用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">viper.RegisterAlias(<span class="string">&quot;loud&quot;</span>, <span class="string">&quot;Verbose&quot;</span>)</span><br><span class="line"></span><br><span class="line">viper.Set(<span class="string">&quot;verbose&quot;</span>, <span class="literal">true</span>) <span class="comment">// same result as next line</span></span><br><span class="line">viper.Set(<span class="string">&quot;loud&quot;</span>, <span class="literal">true</span>)   <span class="comment">// same result as prior line</span></span><br><span class="line"></span><br><span class="line">viper.GetBool(<span class="string">&quot;loud&quot;</span>) <span class="comment">// true</span></span><br><span class="line">viper.GetBool(<span class="string">&quot;verbose&quot;</span>) <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="使用环境变量"><a href="#使用环境变量" class="headerlink" title="使用环境变量"></a>使用环境变量</h3><p>Viper 完全支持环境变量，从而天然满足 <code>12 factor applications</code>。Viper 提供了 5 个方法来支持环境变量：</p>
<ul>
<li><code>AutomaticEnv()</code></li>
<li><code>BindEnv(string...) : error</code></li>
<li><code>SetEnvPrefix(string)</code></li>
<li><code>SetEnvKeyReplacer(string...) *strings.Replacer</code></li>
<li><code>AllowEmptyEnv(bool)</code></li>
</ul>
<p><strong>当使用环境变量时，需要注意 Viper 对待环境变量是大小写敏感的</strong>。</p>
<p>Viper 提供了一种保证变量唯一的机制。<code>SetEnvPrefix</code> 可以告诉 viper 读取变量时都使用一个前缀。这个前缀对 <code>BindEnv</code> 和 <code>AutomaticEnv</code>  方法都有效。</p>
<p><code>BindEnv</code> 接受一个或多个参数。第一个参数是 key 的名称，之后的参数则是与该 key 绑定的环境变量的名称。如果提供了多个，则优先级按照参数顺序进行匹配。如果没有提供，那么 Viper 自动假定环境变量使用如下格式：<code>prefix </code> + <code>_</code> + <code>全大写形式的 key</code>。注意，如果显示提供了环境变量名称，不会自动添加 prefix。例如如果第二个参数是 <code>id</code>，那么 Viper 会查找名称为 <code>ID</code> 的环境变量。</p>
<p>使用环境变量还有一点需要注意，每次访问值的时候都会重新读取读取，而不是在调用 <code>BindEnv</code> 时固定值。</p>
<p>当使用 <code>AutomaticEnv</code> 时，每次调用 <code>viper.Get</code> 时 Viper 都会检查环境变量：所检查的环境变量名称为 <code>prefix</code> + <code>全大写形式的 key</code>。</p>
<p><code>SetEnvKeyReplacer</code> 允许你使用一个 <code>strings.Replacer</code> 对象来重写 Env 的 key。例如当你使用 <code>Get()</code> 时希望使用 <code>-</code>，但环境变量却使用 <code>_</code> 作为分隔符，此时该方法就可以发挥作用了。</p>
<p>或者你可以在 <code>NewWithOptions</code> 中使用 <code>EnvKeyReplacer</code> 选项，和 <code>SetEnvKeyReplacer</code> 不同，它可以接受一个 <code>StringReplacer</code> 接口，从而允许你自定义字符串替换逻辑。</p>
<p>默认空的环境变量被认为是 <code>unset</code> 的，因此会继续尝试下一个配置源。如果需要将空的环境变量认为是 <code>set</code> 的，可以使用 <code>SetEnvKeyReplacer</code> 方法。</p>
<p>如下是使用 Env 的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SetEnvPrefix(<span class="string">&quot;spf&quot;</span>) <span class="comment">// will be uppercased automatically</span></span><br><span class="line">BindEnv(<span class="string">&quot;id&quot;</span>)</span><br><span class="line"></span><br><span class="line">os.Setenv(<span class="string">&quot;SPF_ID&quot;</span>, <span class="string">&quot;13&quot;</span>) <span class="comment">// typically done outside of the app</span></span><br><span class="line"></span><br><span class="line">id := Get(<span class="string">&quot;id&quot;</span>) <span class="comment">// 13</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-Flags"><a href="#使用-Flags" class="headerlink" title="使用 Flags"></a>使用 Flags</h3><p>Viper 支持和 flags 绑定，具体来说，Viper 支持 Cobra 库中使用的 Pflags。</p>
<p>和 <code>BindEnv</code> 类似，并不是 bind 方法调用时设置值，而是在访问时设置值的。所以可以任意早（甚至在 <code>init()</code> 中&#96; 地调用 bind 方法。例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">serverCmd.Flags().Int(<span class="string">&quot;port&quot;</span>, <span class="number">1138</span>, <span class="string">&quot;Port to run Application server on&quot;</span>)</span><br><span class="line">viper.BindPFlag(<span class="string">&quot;port&quot;</span>, serverCmd.Flags().Lookup(<span class="string">&quot;port&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>也可以绑定到一个已经存在的 pflags set 上：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pflag.Int(<span class="string">&quot;flagname&quot;</span>, <span class="number">1234</span>, <span class="string">&quot;help message for flagname&quot;</span>)</span><br><span class="line"></span><br><span class="line">pflag.Parse()</span><br><span class="line">viper.BindPFlags(pflag.CommandLine)</span><br><span class="line"></span><br><span class="line">i := viper.GetInt(<span class="string">&quot;flagname&quot;</span>) <span class="comment">// retrieve values from viper instead of pflag</span></span><br></pre></td></tr></table></figure>

<p>Viper 使用 pflag 包并不妨碍其他包使用标准库中的 flag 包。通过导入这些 flag，pflag 包可以处理那些由 flag 包定义的 flag。该操作由 pflag 包提供的 <code>AddGoFlagSet()</code> 实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;flag&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/spf13/pflag&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// using standard library &quot;flag&quot; package</span></span><br><span class="line">	flag.Int(<span class="string">&quot;flagname&quot;</span>, <span class="number">1234</span>, <span class="string">&quot;help message for flagname&quot;</span>)</span><br><span class="line"></span><br><span class="line">	pflag.CommandLine.AddGoFlagSet(flag.CommandLine)</span><br><span class="line">	pflag.Parse()</span><br><span class="line">	viper.BindPFlags(pflag.CommandLine)</span><br><span class="line"></span><br><span class="line">	i := viper.GetInt(<span class="string">&quot;flagname&quot;</span>) <span class="comment">// retrieve value from viper</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你不使用 <code>Pflags</code>，Viper 提供了两个接口来绑定其他 flag 包：</p>
<ul>
<li><code>FlagValue</code> 代表单个 flag，一旦实现该接口，可以让 Viper 绑定它：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myFlag <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f myFlag)</span></span> HasChanged() <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f myFlag)</span></span> Name() <span class="type">string</span> &#123; <span class="keyword">return</span> <span class="string">&quot;my-flag-name&quot;</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f myFlag)</span></span> ValueString() <span class="type">string</span> &#123; <span class="keyword">return</span> <span class="string">&quot;my-flag-value&quot;</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f myFlag)</span></span> ValueType() <span class="type">string</span> &#123; <span class="keyword">return</span> <span class="string">&quot;string&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">viper.BindFlagValue(<span class="string">&quot;my-flag-name&quot;</span>, myFlag&#123;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>FlagValueSet</code> 代表一组 flags，实现了该接口后，同样可以让 Viper 绑定它</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myFlagSet <span class="keyword">struct</span> &#123;</span><br><span class="line">	flags []myFlag</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f myFlagSet)</span></span> VisitAll(fn <span class="function"><span class="keyword">func</span><span class="params">(FlagValue)</span></span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> _, flag := <span class="keyword">range</span> flags &#123;</span><br><span class="line">		fn(flag)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fSet := myFlagSet&#123;</span><br><span class="line">	flags: []myFlag&#123;myFlag&#123;&#125;, myFlag&#123;&#125;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">viper.BindFlagValues(<span class="string">&quot;my-flags&quot;</span>, fSet)</span><br></pre></td></tr></table></figure>

<h3 id="远端-Key-x2F-Value-存储支持"><a href="#远端-Key-x2F-Value-存储支持" class="headerlink" title="远端 Key&#x2F;Value 存储支持"></a>远端 Key&#x2F;Value 存储支持</h3><p>为了在 Viper 中开启远端支持，需要匿名导入 <code>viper/remote</code> 包：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import _ <span class="string">&quot;github.com/spf13/viper/remote&quot;</span></span><br></pre></td></tr></table></figure>

<p>Viper 可以从 Key&#x2F;Value（例如 etcd、Cousul 等）的路径检索出配置字符串（例如 JSON、TOML 等）。Viper 支持多个主机，使用 <code>;</code> 分隔：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:4001;http://127.0.0.1:4002.</span><br></pre></td></tr></table></figure>

<p>Viper 使用 <code>crypt</code> 来从 K&#x2F;V 存储中检索配置，这意味着你如果有正确的 <code>gpg</code> 秘钥，你可以将配置值加密存储并自动解密。加密是可选的。<code>crypt</code> 提供了命令行助手，可以直接将配置保存到 K&#x2F;V 存储中，<code>crypt</code> 默认连接到 etcd（<a href="http://127.0.0.1:4001）。">http://127.0.0.1:4001）。</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go get github.com/bketelsen/crypt/bin/crypt</span><br><span class="line">$ crypt <span class="built_in">set</span> -plaintext /config/hugo.json /Users/hugo/settings/config.json</span><br><span class="line"></span><br><span class="line">$ crypt get -plaintext /config/hugo.json</span><br></pre></td></tr></table></figure>

<p>如下是使用 K&#x2F;V 存储的示例，首先是未加密的示例：</p>
<p>etcd：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.AddRemoteProvider(<span class="string">&quot;etcd&quot;</span>, <span class="string">&quot;http://127.0.0.1:4001&quot;</span>,<span class="string">&quot;/config/hugo.json&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>) <span class="comment">// because there is no file extension in a stream of bytes, supported extensions are &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;, &quot;properties&quot;, &quot;props&quot;, &quot;prop&quot;, &quot;env&quot;, &quot;dotenv&quot;</span></span><br><span class="line">err := viper.ReadRemoteConfig()</span><br></pre></td></tr></table></figure>

<p>etcd3：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.AddRemoteProvider(<span class="string">&quot;etcd3&quot;</span>, <span class="string">&quot;http://127.0.0.1:4001&quot;</span>,<span class="string">&quot;/config/hugo.json&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>) <span class="comment">// because there is no file extension in a stream of bytes, supported extensions are &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;, &quot;properties&quot;, &quot;props&quot;, &quot;prop&quot;, &quot;env&quot;, &quot;dotenv&quot;</span></span><br><span class="line">err := viper.ReadRemoteConfig()</span><br></pre></td></tr></table></figure>

<p>Consul：</p>
<p>首先需要在 <code>Consul</code> 中设置一个 Key，其 Value 是你希望保存的配置，例如创建一个 <code>MY_CONSUL_KEY</code>，其 value 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;port&quot;</span>: 8080,</span><br><span class="line">    <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;myhostname.com&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">viper.AddRemoteProvider(<span class="string">&quot;consul&quot;</span>, <span class="string">&quot;localhost:8500&quot;</span>, <span class="string">&quot;MY_CONSUL_KEY&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>) <span class="comment">// Need to explicitly set this to json</span></span><br><span class="line">err := viper.ReadRemoteConfig()</span><br><span class="line"></span><br><span class="line">fmt.Println(viper.Get(<span class="string">&quot;port&quot;</span>)) <span class="comment">// 8080</span></span><br><span class="line">fmt.Println(viper.Get(<span class="string">&quot;hostname&quot;</span>)) <span class="comment">// myhostname.com</span></span><br></pre></td></tr></table></figure>

<p>Firestore：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.AddRemoteProvider(<span class="string">&quot;firestore&quot;</span>, <span class="string">&quot;google-cloud-project-id&quot;</span>, <span class="string">&quot;collection/document&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>) <span class="comment">// Config&#x27;s format: &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;</span></span><br><span class="line">err := viper.ReadRemoteConfig()</span><br></pre></td></tr></table></figure>

<p>NATS：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.AddRemoteProvider(<span class="string">&quot;nats&quot;</span>, <span class="string">&quot;nats://127.0.0.1:4222&quot;</span>, <span class="string">&quot;myapp.config&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>)</span><br><span class="line">err := viper.ReadRemoteConfig()</span><br></pre></td></tr></table></figure>

<p>当然也可以使用 <code>SecureRemoteProvider</code>。如下是使用加密形式的 K&#x2F;V 存储的示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viper.AddSecureRemoteProvider(<span class="string">&quot;etcd&quot;</span>,<span class="string">&quot;http://127.0.0.1:4001&quot;</span>,<span class="string">&quot;/config/hugo.json&quot;</span>,<span class="string">&quot;/etc/secrets/mykeyring.gpg&quot;</span>)</span><br><span class="line">viper.SetConfigType(<span class="string">&quot;json&quot;</span>) <span class="comment">// because there is no file extension in a stream of bytes,  supported extensions are &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;, &quot;properties&quot;, &quot;props&quot;, &quot;prop&quot;, &quot;env&quot;, &quot;dotenv&quot;</span></span><br><span class="line">err := viper.ReadRemoteConfig()</span><br></pre></td></tr></table></figure>

<p>如下展示了如何 watch etcd 中的变化（未加密）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// alternatively, you can create a new viper instance.</span></span><br><span class="line"><span class="keyword">var</span> runtime_viper = viper.New()</span><br><span class="line"></span><br><span class="line">runtime_viper.AddRemoteProvider(<span class="string">&quot;etcd&quot;</span>, <span class="string">&quot;http://127.0.0.1:4001&quot;</span>, <span class="string">&quot;/config/hugo.yml&quot;</span>)</span><br><span class="line">runtime_viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>) <span class="comment">// because there is no file extension in a stream of bytes, supported extensions are &quot;json&quot;, &quot;toml&quot;, &quot;yaml&quot;, &quot;yml&quot;, &quot;properties&quot;, &quot;props&quot;, &quot;prop&quot;, &quot;env&quot;, &quot;dotenv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// read from remote config the first time.</span></span><br><span class="line">err := runtime_viper.ReadRemoteConfig()</span><br><span class="line"></span><br><span class="line"><span class="comment">// unmarshal config</span></span><br><span class="line">runtime_viper.Unmarshal(&amp;runtime_conf)</span><br><span class="line"></span><br><span class="line"><span class="comment">// open a goroutine to watch remote changes forever</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Second * <span class="number">5</span>) <span class="comment">// delay after each request</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// currently, only tested with etcd support</span></span><br><span class="line">		err := runtime_viper.WatchRemoteConfig()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Errorf(<span class="string">&quot;unable to read remote config: %v&quot;</span>, err)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// unmarshal new config into our runtime config struct. you can also use channel</span></span><br><span class="line">		<span class="comment">// to implement a signal to notify the system of the changes</span></span><br><span class="line">		runtime_viper.Unmarshal(&amp;runtime_conf)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<h2 id="从-Viper-中获取值"><a href="#从-Viper-中获取值" class="headerlink" title="从 Viper 中获取值"></a>从 Viper 中获取值</h2><p>Viper 提供了一些方法来基于值的类型获取值，这些函数或方法包括：</p>
<ul>
<li>Get(key string) : any</li>
<li>GetBool(key string) : bool</li>
<li>GetFloat64(key string) : float64</li>
<li>GetInt(key string) : int</li>
<li>GetIntSlice(key string) : []int</li>
<li>GetString(key string) : string</li>
<li>GetStringMap(key string) : map[string]any</li>
<li>GetStringMapString(key string) : map[string]string</li>
<li>GetStringSlice(key string) : []string</li>
<li>GetTime(key string) : time.Time</li>
<li>GetDuration(key string) : time.Duration</li>
<li>IsSet(key string) : bool</li>
<li>AllSettings() : map[string]any</li>
</ul>
<p>如果配置没有找到，以上函数都会返回一个 <code>零值</code>。所以为了检查 key 是否存在，提供了 <code>IsSet()</code> 方法。另外，即使配置存在，但是将其值转换为指定的类型失败时，也会返回 <code>零值</code>。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">viper.<span class="title function_ invoke__">GetString</span>(<span class="string">&quot;logfile&quot;</span>) <span class="comment">// case-insensitive Setting &amp; Getting</span></span><br><span class="line"><span class="keyword">if</span> viper.<span class="title function_ invoke__">GetBool</span>(<span class="string">&quot;verbose&quot;</span>) &#123;</span><br><span class="line">	fmt.<span class="title function_ invoke__">Println</span>(<span class="string">&quot;verbose enabled&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="访问嵌套的-key"><a href="#访问嵌套的-key" class="headerlink" title="访问嵌套的 key"></a>访问嵌套的 key</h3><p>以上访问方法支持格式化的路径来检索深层嵌套的 key。例如如果存在如下 json 配置文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">5799</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3099</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;warehouse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;198.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2112</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以使用如下方法进行嵌套 key 的访问：使用 <code>.</code> 作为 key 路径的分隔符：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetString(<span class="string">&quot;datastore.metric.host&quot;</span>) <span class="comment">// (returns &quot;127.0.0.1&quot;)</span></span><br></pre></td></tr></table></figure>

<p>这个查找过程仍然符合上面介绍的配置源搜索优先级。例如对于该配置文件，<code>datastore.metric.host</code>、<code>datastore.metric.port</code> 都被正常定义了。如果默认值中有 <code>datastore.metric.protocol</code>，Viper 也可以找到该配置。但是如果 <code>datastore.metric</code> 被某个值直接覆盖了（例如通过 Set()、环境变量等等），那么 <code>datastore.metric</code> 下的所有子 key 都是未定义状态：它们被优先级更高的配置源给 <code>shadowed</code> 了。</p>
<p>Viper 可以在 path 中使用索引访问数组中的元素：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">5799</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">6029</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3099</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;warehouse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;198.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2112</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetInt(<span class="string">&quot;host.ports.1&quot;</span>) <span class="comment">// returns 6029</span></span><br></pre></td></tr></table></figure>

<p>最后，如果存在某个 key 匹配该分隔路径，那么会直接返回该 key 的值：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;datastore.metric.host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">5799</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;datastore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3099</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;warehouse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;198.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2112</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GetString(<span class="string">&quot;datastore.metric.host&quot;</span>) <span class="comment">// returns &quot;0.0.0.0&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="提取子树"><a href="#提取子树" class="headerlink" title="提取子树"></a>提取子树</h3><p>当开发一些可重用的模块时，通常需要提取配置中的某个子集并将其传递给模块。通过这种方式，模块可以多次实例化，每次使用不同的配置。</p>
<p>例如某个应用程序可以根据不同的目的使用不同的 cache 配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cache:</span><br><span class="line">  cache1:</span><br><span class="line">    max-items: 100</span><br><span class="line">    item-size: 64</span><br><span class="line">  cache2:</span><br><span class="line">    max-items: 200</span><br><span class="line">    item-size: 80</span><br></pre></td></tr></table></figure>

<p>我们可以给模块直接传递 cache 的名称，例如 <code>NewCache(&quot;cache1&quot;)</code>，但是这种方式在访问 key 时需要进行额外的连接，而且和全局配置也无法隔开。更好的方法是直接传递给 Viper 某个配置的子集：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cache1Config := viper.Sub(<span class="string">&quot;cache.cache1&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> cache1Config == <span class="literal">nil</span> &#123; <span class="comment">// Sub returns nil if the key cannot be found</span></span><br><span class="line">	<span class="built_in">panic</span>(<span class="string">&quot;cache configuration not found&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cache1 := NewCache(cache1Config)</span><br></pre></td></tr></table></figure>

<p>在 NewCache 函数内部可以直接访问 <code>max-items</code>、<code>item-size</code> keys：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCache</span><span class="params">(v *Viper)</span></span> *Cache &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Cache&#123;</span><br><span class="line">		MaxItems: v.GetInt(<span class="string">&quot;max-items&quot;</span>),</span><br><span class="line">		ItemSize: v.GetInt(<span class="string">&quot;item-size&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们的代码更加容易测试，也更易于使用，因为它和全局配置结构解耦了。</p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p>你也可以将所有或特定的值反序列化到 struct、map 等。Viper 提供了两个方法：</p>
<ul>
<li>Unmarshal(rawVal any) : error</li>
<li>UnmarshalKey(key string, rawVal any) : error</li>
</ul>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> config <span class="keyword">struct</span> &#123;</span><br><span class="line">	Port <span class="type">int</span></span><br><span class="line">	Name <span class="type">string</span></span><br><span class="line">	PathMap <span class="type">string</span> <span class="string">`mapstructure:&quot;path_map&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> C config</span><br><span class="line"></span><br><span class="line">err := viper.Unmarshal(&amp;C)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	t.Fatalf(<span class="string">&quot;unable to decode into struct, %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要反序列化的配置本身就包含 <code>.</code>（默认的 key 分隔符），你可以修改分隔符：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">v := viper.NewWithOptions(viper.KeyDelimiter(<span class="string">&quot;::&quot;</span>))</span><br><span class="line"></span><br><span class="line">v.SetDefault(<span class="string">&quot;chart::values&quot;</span>, <span class="keyword">map</span>[<span class="type">string</span>]any&#123;</span><br><span class="line">	<span class="string">&quot;ingress&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]any&#123;</span><br><span class="line">		<span class="string">&quot;annotations&quot;</span>: <span class="keyword">map</span>[<span class="type">string</span>]any&#123;</span><br><span class="line">			<span class="string">&quot;traefik.frontend.rule.type&quot;</span>:                 <span class="string">&quot;PathPrefix&quot;</span>,</span><br><span class="line">			<span class="string">&quot;traefik.ingress.kubernetes.io/ssl-redirect&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> config <span class="keyword">struct</span> &#123;</span><br><span class="line">	Chart <span class="keyword">struct</span>&#123;</span><br><span class="line">		Values <span class="keyword">map</span>[<span class="type">string</span>]any</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> C config</span><br><span class="line"></span><br><span class="line">v.Unmarshal(&amp;C)</span><br></pre></td></tr></table></figure>

<p>Viper 也支持反序列化到嵌套的结构体中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Example config:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">module:</span></span><br><span class="line"><span class="comment">    enabled: true</span></span><br><span class="line"><span class="comment">    token: 89h3f98hbwf987h3f98wenf89ehf</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">type</span> config <span class="keyword">struct</span> &#123;</span><br><span class="line">	Module <span class="keyword">struct</span> &#123;</span><br><span class="line">		Enabled <span class="type">bool</span></span><br><span class="line"></span><br><span class="line">		moduleConfig <span class="string">`mapstructure:&quot;,squash&quot;`</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleConfig could be in a module specific package</span></span><br><span class="line"><span class="keyword">type</span> moduleConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	Token <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> C config</span><br><span class="line"></span><br><span class="line">err := viper.Unmarshal(&amp;C)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">	t.Fatalf(<span class="string">&quot;unable to decode into struct, %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Viper 内部是使用 <a href="github.com/mitchellh/mapstructure">mapstructure</a> 来反序列化值的，所以可以看到该库所使用的 <code>mapstructure</code> tag。</p>
<h3 id="自定义格式解码"><a href="#自定义格式解码" class="headerlink" title="自定义格式解码"></a>自定义格式解码</h3><p>Viper 通过使用 <code>mapstructure decode hooks</code> 来支持自定义格式解码，具体可以参考<a target="_blank" rel="noopener" href="https://sagikazarmark.hu/blog/decoding-custom-formats-with-viper/">Decoding custom formats with Viper</a>。</p>
<h3 id="序列化成字符串"><a href="#序列化成字符串" class="headerlink" title="序列化成字符串"></a>序列化成字符串</h3><p>有时你需要将 viper 中保存的配置序列化成字符串，而不是写入文件中。你可以使用你喜欢格式的序列化器将 <code>AllSettings()</code> 返回的配置进行序列化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	yaml <span class="string">&quot;gopkg.in/yaml.v2&quot;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">yamlStringSettings</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	c := viper.AllSettings()</span><br><span class="line">	bs, err := yaml.Marshal(c)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;unable to marshal config to YAML: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">string</span>(bs)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Viper-还是-Vipers"><a href="#Viper-还是-Vipers" class="headerlink" title="Viper 还是 Vipers"></a>Viper 还是 Vipers</h2><p>viper 包开箱即用，不需要配置或初始化就能直接使用 viper。绝大多数应用程序都希望有一个集中的仓库来管理它们的配置信息，viper 包就是这样做的，这类似于单例模式。以上的实例也都是以 <code>单例风格</code> 演示如何使用 viper。</p>
<p>你可以在应用程序中创建多个 viper 实例，每个 viper 实例都有自己唯一的一组配置和值。每个 viper 实例可以从不同的配置文件、K&#x2F;V 存储等读取配置。Viper 包提供的所有函数都有对应的方法（操作在某个 viper 实例上）。</p>
<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x := viper.New()</span><br><span class="line">y := viper.New()</span><br><span class="line"></span><br><span class="line">x.SetDefault(<span class="string">&quot;ContentDir&quot;</span>, <span class="string">&quot;content&quot;</span>)</span><br><span class="line">y.SetDefault(<span class="string">&quot;ContentDir&quot;</span>, <span class="string">&quot;foobar&quot;</span>)</span><br><span class="line"></span><br><span class="line">//...</span><br></pre></td></tr></table></figure>

<p>当使用多个 viper 实例时，由用户来跟踪不同的 viper 实例。</p>
<p><strong>最后需要注意，viper 不是并发安全的。对某个 viper 的实例的并发读写，需要自己做同步操作</strong>。</p>
<h2 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h2><p>当前目录下存在 <code>test.yaml</code> 配置文件，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line">  <span class="bullet">-</span></span><br><span class="line">    <span class="attr">index:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">go</span></span><br><span class="line">    <span class="attr">website:</span> <span class="string">https://go.dev/</span></span><br><span class="line">  <span class="bullet">-</span></span><br><span class="line">    <span class="attr">index:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">python</span></span><br><span class="line">    <span class="attr">website:</span> <span class="string">https://www.python.org/</span></span><br><span class="line">  <span class="bullet">-</span></span><br><span class="line">    <span class="attr">index:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rust</span></span><br><span class="line">    <span class="attr">website:</span> <span class="string">https://www.rust-lang.org/</span></span><br></pre></td></tr></table></figure>

<p>如下 go 程序用于对该配置文件进行读取并反序列化为配置结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LanguagesConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">        Languages []<span class="keyword">struct</span> &#123;</span><br><span class="line">                Index   <span class="type">int</span></span><br><span class="line">                Name    <span class="type">string</span></span><br><span class="line">                Website <span class="type">string</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        viper.SetConfigName(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">        viper.SetConfigType(<span class="string">&quot;yaml&quot;</span>)</span><br><span class="line">        viper.AddConfigPath(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        err := viper.ReadInConfig()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;read config file error: %w&quot;</span>, err))</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> languages LanguagesConfig</span><br><span class="line">        viper.Unmarshal(&amp;languages)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, l := <span class="keyword">range</span> languages.Languages &#123;</span><br><span class="line">                fmt.Println(l.Index, l.Name, l.Website)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/spf13/viper">viper</a></li>
<li><a target="_blank" rel="noopener" href="https://12factor.net/zh_cn/">The Twelve-Factor App</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/fuchencong.github.io/tags/Go/" rel="tag"># Go</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2023/12/28/go-library-fx/" rel="prev" title="go 库学习之 fx">
      <i class="fa fa-chevron-left"></i> go 库学习之 fx
    </a></div>
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2023/10/22/bulletproof-ssl-and-tls-02/" rel="next" title="《HTTPS 权威指南》读书笔记（02）：协议">
      《HTTPS 权威指南》读书笔记（02）：协议 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Viper-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">Viper 简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%8A%E5%80%BC%E5%AD%98%E5%85%A5-Viper-%E4%B8%AD"><span class="nav-number">2.</span> <span class="nav-text">把值存入 Viper 中</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="nav-number">2.1.</span> <span class="nav-text">设置默认值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E8%AF%BB%E5%8F%96"><span class="nav-number">2.2.</span> <span class="nav-text">从配置文件中读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.3.</span> <span class="nav-text">写入配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E5%B9%B6%E9%87%8D%E6%96%B0%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.4.</span> <span class="nav-text">监控并重新读取配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E-io-Reader-%E4%B8%AD%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE"><span class="nav-number">2.5.</span> <span class="nav-text">从 io.Reader 中读取配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%86%E7%9B%96%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.6.</span> <span class="nav-text">覆盖设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%88%AB%E5%90%8D"><span class="nav-number">2.7.</span> <span class="nav-text">注册并使用别名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-number">2.8.</span> <span class="nav-text">使用环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Flags"><span class="nav-number">2.9.</span> <span class="nav-text">使用 Flags</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%AB%AF-Key-x2F-Value-%E5%AD%98%E5%82%A8%E6%94%AF%E6%8C%81"><span class="nav-number">2.10.</span> <span class="nav-text">远端 Key&#x2F;Value 存储支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E-Viper-%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%80%BC"><span class="nav-number">3.</span> <span class="nav-text">从 Viper 中获取值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%B5%8C%E5%A5%97%E7%9A%84-key"><span class="nav-number">3.1.</span> <span class="nav-text">访问嵌套的 key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E5%8F%96%E5%AD%90%E6%A0%91"><span class="nav-number">3.2.</span> <span class="nav-text">提取子树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">3.3.</span> <span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%BC%E5%BC%8F%E8%A7%A3%E7%A0%81"><span class="nav-number">3.4.</span> <span class="nav-text">自定义格式解码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E6%88%90%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">3.5.</span> <span class="nav-text">序列化成字符串</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Viper-%E8%BF%98%E6%98%AF-Vipers"><span class="nav-number">4.</span> <span class="nav-text">Viper 还是 Vipers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.</span> <span class="nav-text">简单示例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fuchencong"
      src="/fuchencong.github.io/images/logo.jpeg">
  <p class="site-author-name" itemprop="name">fuchencong</p>
  <div class="site-description" itemprop="description">Having dreams is what makes life tolerable.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/fuchencong.github.io/archives/">
        
          <span class="site-state-item-count">184</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/fuchencong.github.io/categories/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/fuchencong.github.io/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/fuchencong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fuchencong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fuchencong@163.com" title="E-Mail → mailto:fuchencong@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fuchencong</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/fuchencong.github.io/lib/anime.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/fuchencong.github.io/js/utils.js"></script>

<script src="/fuchencong.github.io/js/motion.js"></script>


<script src="/fuchencong.github.io/js/schemes/muse.js"></script>


<script src="/fuchencong.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
