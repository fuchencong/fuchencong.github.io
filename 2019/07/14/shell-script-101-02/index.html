<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/fuchencong.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/fuchencong.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/fuchencong.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/fuchencong.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/fuchencong.github.io/css/main.css">


<link rel="stylesheet" href="/fuchencong.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fuchencong.github.io","root":"/fuchencong.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Unix 的优点之一就是允许你根据现有的命令创建出新的程序。尽管 Unix 已经有上百个命令，而且可以通过多种方式来组合他们，但是有时候我们还是会碰到不够用的情况。Perl、Python，甚至 C 都包含了库以提供扩展能力，而 shell 脚本更像是一个自己动手的世界。本章将创建一个基础脚本库，通过它们可以编写出更加复杂的脚本。">
<meta property="og:type" content="article">
<meta property="og:title" content="Shell 脚本 101（2）：缺失的代码库">
<meta property="og:url" content="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/index.html">
<meta property="og:site_name" content="fuchencong">
<meta property="og:description" content="Unix 的优点之一就是允许你根据现有的命令创建出新的程序。尽管 Unix 已经有上百个命令，而且可以通过多种方式来组合他们，但是有时候我们还是会碰到不够用的情况。Perl、Python，甚至 C 都包含了库以提供扩展能力，而 shell 脚本更像是一个自己动手的世界。本章将创建一个基础脚本库，通过它们可以编写出更加复杂的脚本。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/images/01-color.png">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/images/01-library-1.png">
<meta property="article:published_time" content="2019-07-14T06:26:00.000Z">
<meta property="article:modified_time" content="2024-03-18T09:45:13.065Z">
<meta property="article:author" content="fuchencong">
<meta property="article:tag" content="Bash">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/images/01-color.png">

<link rel="canonical" href="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Shell 脚本 101（2）：缺失的代码库 | fuchencong</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/fuchencong.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fuchencong</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The way I am</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/fuchencong.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/fuchencong.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/fuchencong.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/fuchencong.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/fuchencong.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuchencong.github.io/fuchencong.github.io/2019/07/14/shell-script-101-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/fuchencong.github.io/images/logo.jpeg">
      <meta itemprop="name" content="fuchencong">
      <meta itemprop="description" content="Having dreams is what makes life tolerable.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuchencong">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shell 脚本 101（2）：缺失的代码库
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-14 14:26:00" itemprop="dateCreated datePublished" datetime="2019-07-14T14:26:00+08:00">2019-07-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/fuchencong.github.io/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Unix 的优点之一就是允许你根据现有的命令创建出新的程序。尽管 Unix 已经有上百个命令，而且可以通过多种方式来组合他们，但是有时候我们还是会碰到不够用的情况。Perl、Python，甚至 C 都包含了库以提供扩展能力，而 shell 脚本更像是一个自己动手的世界。本章将创建一个基础脚本库，通过它们可以编写出更加复杂的脚本。</p>
<span id="more"></span>

<h2 id="POSIX-是什么"><a href="#POSIX-是什么" class="headerlink" title="POSIX 是什么"></a>POSIX 是什么</h2><p>编写shell 脚本的一个挑战就是不同 Unix 以及不同 GNU&#x2F;Linux 发行版之间存在细微差异。IEEE POSIX 标准定义了在不同 Unix 之间需要实现的公共基础功能。POSIX（Portable Operating SystemSystem Interface）是由 IEEE 为 Unix 操作系统定义的一个标准，它规定了什么样的操作系统可以称为 POSIX 兼容 的操作系统，例如 GNU&#x2F;Linux 就是 POSIX 兼容 的操作系统。但是需要注意，即使是 POSIX 兼容 的操作系统，它们之间也会存在差异。</p>
<h2 id="Script-1：在-PATH-中查找程序"><a href="#Script-1：在-PATH-中查找程序" class="headerlink" title="Script 1：在 PATH 中查找程序"></a>Script 1：在 PATH 中查找程序</h2><p>在 shell 脚本中使用环境变量存在一个隐藏的风险：环境变量所指定的程序可能不存在。所以这个脚本将用于测试一个给定的程序是否可以在用户的 PATH 环境变量中找到。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inpath:</span></span><br><span class="line"><span class="comment"># verifies that a specified program is either valid as is</span></span><br><span class="line"><span class="comment"># or can be found in the PATH directory list</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">in_path</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Given a command and the PATH, tries to find the command.</span></span><br><span class="line">    <span class="comment"># Returns 0 if found the executable. 1 if not.</span></span><br><span class="line">    <span class="comment"># Note that this temporarily modifies the IFS (internal field separator)</span></span><br><span class="line">    <span class="comment"># but restores it upon completion</span></span><br><span class="line"></span><br><span class="line">    cmd=<span class="variable">$1</span></span><br><span class="line">    ourpath=<span class="variable">$2</span></span><br><span class="line">    result=1</span><br><span class="line"></span><br><span class="line">    oldIFS=IFS</span><br><span class="line">    IFS=<span class="string">&quot;:&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> directory <span class="keyword">in</span> <span class="variable">$ourpath</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -x <span class="variable">$directory</span>/<span class="variable">$cmd</span> ]; <span class="keyword">then</span></span><br><span class="line">            result=0    <span class="comment"># if we&#x27;re here, we found the command</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$result</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_cmd_in_path</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    var=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$var</span>&quot;</span> != <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;var:0:1&#125;</span>&quot;</span> = <span class="string">&quot;/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ ! -x <span class="variable">$var</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">return</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">elif</span> ! in_path <span class="variable">$var</span> <span class="string">&quot;<span class="variable">$PATH</span>&quot;</span> ; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p><code>check_in_cmd_path()</code> 函数用于检测一个命令是否存在，命令可以仅仅是程序名（例如 echo），也可以是完整的绝对路径（例如 &#x2F;bin&#x2F;echo）。这里通过 <code>$&#123;var:0:1&#125;</code> 来获取字符串的第一个字符并判断是否是 &#x2F;。</p>
<p><code>$&#123;var:offset:length&#125;</code> 是字符串操作语法，用于获取字符串变量 var 从 offset 处开始的长度为 length 的子串。如果没有指定长度，则返回到字符串结尾的所有部分。以下是一个例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ var=<span class="string">&quot;this is a test string...&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var:10&#125;</span></span><br><span class="line"><span class="built_in">test</span> string...</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var:10:5&#125;</span></span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>对于通过绝对路径指定的命令，直接通过 -x 检测该文件是否存在（同时必须是一个可执行文件），否则传递给 in_path 函数，检查其是否可以在 PATH 环境变量中找到。</p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>为了单独运行该脚本，需要在该文件末尾中添加一些测试代码。如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> command&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check_cmd_in_path <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="keyword">case</span> $? <span class="keyword">in</span></span><br><span class="line">    0 ) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> found&quot;</span>                         ;;</span><br><span class="line">    1 ) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> not found in absolute path&quot;</span>    ;;</span><br><span class="line">    2 ) <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> not found in PATH&quot;</span>             ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>以下展示了该脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./inpath.sh <span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> found</span><br><span class="line">$ ./inpath.sh noecho</span><br><span class="line">noecho not found <span class="keyword">in</span> PATH</span><br><span class="line">$ ./inpath.sh /bin/noecho</span><br><span class="line">/bin/noecho not found <span class="keyword">in</span> absolute path</span><br></pre></td></tr></table></figure>

<h3 id="Hacking"><a href="#Hacking" class="headerlink" title="Hacking"></a>Hacking</h3><p>如果你想让你的脚本更上去更高级一点，可以将 ${var:0:1} 替换为 ${var%${var#?}}，这种字符串操作方法也可以用于获取变量 var 中的第一个字符。这里用到了 bash 中的字符串模式匹配语法：</p>
<ul>
<li>${var#pattern}：从前往后，删除从字符串开始到匹配 pattern 之间的所有字符，采用最短匹配</li>
<li>${var##pattern}：从前往后，删除从字符串开始到匹配 pattern 之间的所有字符，采用最长匹配</li>
<li>${var%pattern}：从后往前，删除从字符串末尾到匹配 pattern 之间的所有字符，采用最短匹配</li>
<li>${var%%pattern}：从后往前，删除从字符串末尾到匹配 pattern 之间的所有字符，采用最长匹配</li>
</ul>
<p>pattern 可以采用 bash 中的通配符语法，举个例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ var=<span class="string">&quot;/home/fuchencong/test.file&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var#*/&#125;</span></span><br><span class="line">home/fuchencong/test.file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var##*/&#125;</span></span><br><span class="line">test.file</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var%/*&#125;</span></span><br><span class="line">/home/fuchencong</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;var%%/*&#125;</span></span><br></pre></td></tr></table></figure>

<p>而 <code>$&#123;var%$&#123;var#?&#125;&#125;</code> 包含两个字符串切片操作，内层的 <code>$&#123;var#?&#125;</code> 用于获取去除第一个字符之后的剩余字符串，其中 <code>?</code> 通配符用于匹配任意一个字符，之后再通过 <code>$&#123;var%$&#123;var#?&#125;&#125;</code> 的方式得到第一个字符。</p>
<p>另外也可以通过 <code>$(echo $var | cut -c1)</code> 的方式获取第一个字符。</p>
<p>另外一个技巧是，如果想要脚本单独执行时才运行测试代码，而被其它脚本调用时则不运行测试代码，可以通过 <code>BASH_SOURCE</code> 实现这一点。BASH_SOURCE 是 bash 定义的一个数组，可以认为其维护了脚本调用栈的关系，BASH_SOURCE[0] 是当前脚本的文件名，而 BASH_SOURCE[1] 则是调用者的脚本文件名，依次类推。</p>
<p>可以通过如下语句，判断当前脚本是单独执行，还是被其它脚本调用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]</span><br></pre></td></tr></table></figure>

<ul>
<li>如果当前脚本是单独执行，则 $BASH_SOURCE 等于 $0，都是表示当前脚本文件名</li>
<li>而如果脚本是被其它脚本执行，则 $BASH_SOURCE 为当前脚本名，而 $0 则是调用者的脚本名</li>
<li>注意，$BASH_SOURCE 等效于 $BASH_SOURCE[0]，这是 bash 数组的语法</li>
</ul>
<p>如果例子展示了 BASH_SOURCE 的相关用法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;inner script: \$0=<span class="variable">$0</span>, BASH_SOURCE[0]=<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Before: outer script: \$0=<span class="variable">$0</span>, BASH_SOURCE[0]=<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">source</span> ./inner.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;After: outer script: \$0=<span class="variable">$0</span>, BASH_SOURCE[0]=<span class="variable">$&#123;BASH_SOURCE[0]&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sh outer.sh</span><br><span class="line">Before: outer script: <span class="variable">$0</span>=outer.sh, BASH_SOURCE[0]=outer.sh</span><br><span class="line">inner script: <span class="variable">$0</span>=outer.sh, BASH_SOURCE[0]=./inner.sh</span><br><span class="line">After: outer script: <span class="variable">$0</span>=outer.sh, BASH_SOURCE[0]=outer.sh</span><br></pre></td></tr></table></figure>

<p>哈哈，BASH_SOURCE 的用法和 Python 中 <code>__name__</code> 是不是有异曲同工之妙。</p>
<h2 id="Script-2：检查输入，只接受数字和字母"><a href="#Script-2：检查输入，只接受数字和字母" class="headerlink" title="Script 2：检查输入，只接受数字和字母"></a>Script 2：检查输入，只接受数字和字母</h2><p>用户的输入可能与脚本预期不符，所以在编写脚本时通常需要检查输入的合法性。如果我们的输入只接受数字和字母，而不可以包括任何标点符号、特殊字符、空格等，可以通过如下脚本进行检验。</p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># valid_alpha_num.sh</span></span><br><span class="line"><span class="comment"># Ensure that input consists only of alphabetical</span></span><br><span class="line"><span class="comment"># and numeric characters</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">valid_alpha_num</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Validate arg: return 0 if all upper + lower + digits; 1 otherwise</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Remove all unacceptable chars</span></span><br><span class="line">    validchars=<span class="string">&quot;<span class="subst">$(echo $1 | sed &#x27;s/[^[:alnum:]]//g&#x27;)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$validchars</span>&quot;</span> = <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;Enter input: &quot;</span></span><br><span class="line">    <span class="built_in">read</span> input</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ! valid_alpha_num <span class="string">&quot;<span class="variable">$input</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Please enter only letters and numbers.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Input is valid&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>这个脚本最核心的代码是使用 sed 将输入字符串中的所有非法字符去除，然后将去除后的结果和原始字符串进行比较，如果相同，则代表原始字符串不包含非法字符。</p>
<p>这里 sed 使用了 POSIX 正则表达式 <code>[:alphanum]</code> 用于匹配所有字母和数字字符，而 <code>[^[:alphanum:]]</code> 则用于匹配不是字母也不是数字的字符，然后将这些字符替换为空，即达到删除这些字符的效果。</p>
<h3 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h3><p>以下展示了这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ./valid_alpha_num.sh</span><br><span class="line">Enter input: abcd</span><br><span class="line">Input is valid</span><br><span class="line"></span><br><span class="line">$ ./valid_alpha_num.sh</span><br><span class="line">Enter input: 32</span><br><span class="line">Input is valid</span><br><span class="line"></span><br><span class="line">$ ./valid_alpha_num.sh</span><br><span class="line">Enter input: 99abc</span><br><span class="line">Input is valid</span><br><span class="line"></span><br><span class="line">$ ./valid_alpha_num.sh</span><br><span class="line">Enter input: .abc</span><br><span class="line">Please enter only letters and numbers.</span><br><span class="line"></span><br><span class="line">$ ./valid_alpha_num.sh</span><br><span class="line">Enter input: _99a</span><br><span class="line">Please enter only letters and numbers.</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-1"><a href="#Hacking-1" class="headerlink" title="Hacking"></a>Hacking</h3><p>移除非法字符，然后将移除后的结果与原始字符串进行比较，这种技巧非常灵活。例如如果只接受大写字母，同时也接受空格、逗号和句号，可以编写如下 sed 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/[^[:upper:] ,.]//g&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Script-3：标准化日期格式"><a href="#Script-3：标准化日期格式" class="headerlink" title="Script 3：标准化日期格式"></a>Script 3：标准化日期格式</h2><p>开发 shell 脚本的一个问题是数据格式的不一致，而对日期的格式化又最为困难，因为可以通过多种方式指定日期。接下来的脚本将对输入的日期进行格式化。</p>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># normalize_date.sh</span></span><br><span class="line"><span class="comment"># Normalizes month field in date specification to three letters,</span></span><br><span class="line"><span class="comment"># first letter capitalized.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">month_num_to_name</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Sets the &#x27;month&#x27; variable to the appropriate value</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        1)  month=<span class="string">&quot;Jan&quot;</span>     ;;</span><br><span class="line">        2)  month=<span class="string">&quot;Feb&quot;</span>     ;;</span><br><span class="line">        3)  month=<span class="string">&quot;Mar&quot;</span>     ;;</span><br><span class="line">        4)  month=<span class="string">&quot;Apr&quot;</span>     ;;</span><br><span class="line">        5)  month=<span class="string">&quot;May&quot;</span>     ;;</span><br><span class="line">        6)  month=<span class="string">&quot;Jun&quot;</span>     ;;</span><br><span class="line">        7)  month=<span class="string">&quot;Jul&quot;</span>     ;;</span><br><span class="line">        8)  month=<span class="string">&quot;Aug&quot;</span>     ;;</span><br><span class="line">        9)  month=<span class="string">&quot;Sep&quot;</span>     ;;</span><br><span class="line">        10) month=<span class="string">&quot;Oct&quot;</span>     ;;</span><br><span class="line">        11) month=<span class="string">&quot;Nov&quot;</span>     ;;</span><br><span class="line">        12) month=<span class="string">&quot;Dec&quot;</span>     ;;</span><br><span class="line">        *)  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: Unknown month value <span class="variable">$1</span>&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$#</span> -ne 3 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> month day year&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Formats are Auguest 3 1962 and 8 3 1962&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$3</span> -le 999 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: expected 4-digit year value.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Is the month input format a number</span></span><br><span class="line">    <span class="keyword">if</span> [ -z $(<span class="built_in">echo</span> <span class="variable">$1</span> | sed <span class="string">&#x27;s/[[:digit:]]//g&#x27;</span>) ]; <span class="keyword">then</span></span><br><span class="line">        month_num_to_name <span class="variable">$1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        month=<span class="string">&quot;<span class="subst">$(echo $1 | cut -c1 | tr &#x27;[:lower:]&#x27; &#x27;[:upper:]&#x27;)</span>&quot;</span></span><br><span class="line">        month=<span class="string">&quot;$month<span class="subst">$(echo $1 | cut -c2-3 | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$month</span> <span class="variable">$2</span> <span class="variable">$3</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>这个脚本只能进行简单的格式化，其接受 <code>Month Day Year</code> 形式的输入，可以将数字形式或字符串形式的月份统一转换为三个字符的简写形式，另外年份只能是 4 位数字格式。</p>
<p>通过 <code>[ -z $(echo $1 | sed &#39;s/[[:digit:]]//g&#39;) ]</code> 判断输入的月份是否只包含数字。</p>
<ul>
<li><code>[ -z $string ]</code> 用于判断一个字符串是否为空</li>
<li>sed 命令 <code>sed &#39;s/[[:digit:]]//g&#39;</code> 用于删除输入月份中的所有数字</li>
<li>删除所有数字后，如果字符串为空，则代表输入的月份中只包含数字</li>
</ul>
<p>如果输入的月份只包含数字，则调用 month_num_to_name 将数字形式的月份转换为标准形式。否则则认为输入的是字符串形式的月份，通过 cut 与 tr 命令获取标准形式的输出：</p>
<ul>
<li>首先获取输入月份中的第 1 个字符，并将其转化为大写形式</li>
<li>然后获取输入月份中的第 2-3 个字符串，并将其转化为小写形式</li>
<li>要获取第一个字符，也可以这种方式实现：${1%${1#?}}</li>
</ul>
<h3 id="运行-2"><a href="#运行-2" class="headerlink" title="运行"></a>运行</h3><p>如下展示了这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./normalize_date.sh 9 21 1993</span><br><span class="line">Sep 21 1993</span><br><span class="line">$ ./normalize_date.sh september 21 1993</span><br><span class="line">Sep 21 1993</span><br><span class="line">$ ./normalize_date.sh Sep 21 1993</span><br><span class="line">Sep 21 1993</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-2"><a href="#Hacking-2" class="headerlink" title="Hacking"></a>Hacking</h3><p>这个脚本的功能还是比较简单，可以对其进行更多扩展。如果想让脚本可以接收 MM&#x2F;DD&#x2F;YYYY 或 MM-DD-YYYY 格式的输入，可以添加如下代码实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># to compensate for / or - formats</span></span><br><span class="line">    <span class="built_in">set</span> -- $(<span class="built_in">echo</span> <span class="variable">$1</span> | sed <span class="string">&#x27;s/[\/\-]/ /g&#x27;</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>如果参数格式只有 1 个，则认为是 MM&#x2F;DD&#x2F;YYYY 或 MM-DD-YYYY 格式的输入，然后通过 <code>$(echo $1 | sed &#39;s/[\/\-]/ /g&#39;)</code> 将其替换为 3 个以空格分隔的字符串，<strong>然后通过 set – 命令重置位置参数，将位置参数重新变换为 month day year 的形式</strong>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./normalize_date.sh Sep/21/1993</span><br><span class="line">Sep 21 1993</span><br><span class="line">$ ./normalize_date.sh 9/21/1993</span><br><span class="line">Sep 21 1993</span><br></pre></td></tr></table></figure>

<h2 id="Script-4：格式友好地输出大数"><a href="#Script-4：格式友好地输出大数" class="headerlink" title="Script 4：格式友好地输出大数"></a>Script 4：格式友好地输出大数</h2><p>对于非常大的数字，可以以更友好的格式进行输出，例如每三位数字之间插入一个逗号。如下脚本实现了该功能。</p>
<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nice_number.sh</span></span><br><span class="line"><span class="comment"># Given a number, show it in comma-separated form. Expects DD</span></span><br><span class="line"><span class="comment"># (decimal point delimiter) and TD(thousands delimiter) to be</span></span><br><span class="line"><span class="comment"># instantiated. Instantiates nicenum or, if a second arg is specified,</span></span><br><span class="line"><span class="comment"># the output is echoed to stdout.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">nice_number</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Note that we assume that . is the decimal separator in the INPUT value,</span></span><br><span class="line">    <span class="comment"># the decimal separator in the output value is &quot;.&quot; unless specified by</span></span><br><span class="line">    <span class="comment"># the user with the -d flag.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">integer</span>=$(<span class="built_in">echo</span> <span class="variable">$1</span> | <span class="built_in">cut</span> -d. -f 1)</span><br><span class="line">    decimal=$(<span class="built_in">echo</span> <span class="variable">$1</span> | <span class="built_in">cut</span> -d. -f 2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$decimal</span>&quot;</span> != <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        result=<span class="string">&quot;<span class="variable">$&#123;DD:=&#x27;.&#x27;&#125;</span><span class="variable">$decimal</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    thousands=<span class="variable">$integer</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> [ <span class="variable">$thousands</span> -gt 999 ]; <span class="keyword">do</span></span><br><span class="line">        remainder=$((<span class="variable">$thousands</span> % <span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># we need &#x27;remainder&#x27; to be three digits, maybe need to add zeros</span></span><br><span class="line">        <span class="keyword">while</span> [ <span class="variable">$&#123;#remainder&#125;</span> -lt 3 ]; <span class="keyword">do</span></span><br><span class="line">            remainder=<span class="string">&quot;0<span class="variable">$remainder</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">        result=<span class="string">&quot;<span class="variable">$&#123;TD:=&#x27;,&#x27;&#125;</span><span class="variable">$&#123;remainder&#125;</span><span class="variable">$&#123;result&#125;</span>&quot;</span></span><br><span class="line">        thousands=$((thousands / <span class="number">1000</span>))</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    nicenum=<span class="string">&quot;<span class="variable">$&#123;thousands&#125;</span><span class="variable">$&#123;result&#125;</span>&quot;</span></span><br><span class="line">    <span class="comment"># check if need to echo nicenum</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="variable">$2</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$nicenum</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DD=<span class="string">&quot;.&quot;</span>  <span class="comment"># Decimal point delimiter, to seperate whole and fractional values</span></span><br><span class="line">TD=<span class="string">&quot;,&quot;</span>  <span class="comment"># Thousands delimiter, to separate every digits</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;d:t:&quot;</span> opt; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">        d ) DD=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>    ;;</span><br><span class="line">        t ) TD=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>    ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> $((<span class="variable">$OPTIND</span> - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Input validation</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="subst">$(basename $0)</span> [-d c] [-t c] number&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; -d specifies the dicimal point delimiter&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot; -t specifies the thousands delimiter&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">nice_number <span class="variable">$1</span> 1</span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>该脚本还是比较复杂的，用到了很多技巧。这个脚本可以接收任意大的数字，包括小数，然后以友好的格式输出该数字，其中以 TD 作为千位分隔符，以 DD 作为小数分隔符。</p>
<p>函数 nice_number() 完成转换的核心逻辑，涉及的 bash 脚本编程知识：</p>
<ul>
<li>cut 命令中通过 -d 选项指定分隔符，通过 -f 获取分隔后的指定字段，如果输入行不包含分隔符，则直接输出原始行</li>
<li>${var:&#x3D;”value”} 用于实现对变量 var 进行条件赋值。如果变量 var 没有设置或者其值为空，则将 var 赋值为 value，否则 var 仍保留其原始值</li>
<li>bash 中可以通过 $(($thousands % 1000)) 的方式执行算术运算</li>
</ul>
<p>之后脚本的主逻辑中：</p>
<ul>
<li>通过 getopts 来完成参数的解析，$opt 保存当前解析到的选项，通过 $OPTARG 获取当前选项的参数</li>
<li>完成选项解析后，通过 <code>shift $(($OPTIND-1))</code> 将选项参数移除，变量 OPTIND 表示当前解析的参数位于参数数组中的下标</li>
<li>之后 $1 即表示要转换的数字</li>
</ul>
<h3 id="运行-3"><a href="#运行-3" class="headerlink" title="运行"></a>运行</h3><p>以下展示了该脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ./nice_number.sh 100000</span><br><span class="line">100,000</span><br><span class="line">$ ./nice_number.sh 666.888</span><br><span class="line">666.888</span><br><span class="line">$ ./nice_number.sh 66600.888</span><br><span class="line">66,600.888</span><br><span class="line">$ ./nice_number.sh -t _ -d , 6666.888</span><br><span class="line">6_666,888</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-3"><a href="#Hacking-3" class="headerlink" title="Hacking"></a>Hacking</h3><p>在这个脚本中，默认认为用户输入的数字是以 . 作为小数分隔符的，其实更好的方法是以用户通过 -d 选项所指定的符号最为小数分隔位进行解析：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">integer</span>=$(<span class="built_in">echo</span> <span class="variable">$1</span> | <span class="built_in">cut</span> -d<span class="string">&quot;<span class="variable">$DD</span>&quot;</span> -f 1)</span><br><span class="line">decimal=$(<span class="built_in">echo</span> <span class="variable">$1</span> | <span class="built_in">cut</span> -d<span class="string">&quot;<span class="variable">$DD</span>&quot;</span> -f 2)</span><br></pre></td></tr></table></figure>

<p>但是前提是用户的输入的确是采用 $DD 作为小数分隔符，可以再加如下判断：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">separator=$(<span class="built_in">echo</span> <span class="variable">$1</span> | sed <span class="string">&#x27;s/[[:digit]]//g&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$separator</span>&quot;</span> -a <span class="string">&quot;<span class="variable">$separator</span>&quot;</span> != <span class="string">&quot;<span class="variable">$DD</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: Unknown decimal separator <span class="variable">$separator</span> encountered.&quot;</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="Script-5：检查整数输入"><a href="#Script-5：检查整数输入" class="headerlink" title="Script 5：检查整数输入"></a>Script 5：检查整数输入</h2><p>本脚本将检查输入是否是一个合法的整数，可以接受负数。通过如果指定了一个范围，将检查输入是否在范围中。</p>
<h3 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># valid_integer.sh</span></span><br><span class="line"><span class="comment"># Validates integer input, allowing negative integers too</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">valid_int</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Validate first field and test the value against min value $2 and/or</span></span><br><span class="line">    <span class="comment"># max value $3 if they are supplied. If the value isn&#x27;t within range</span></span><br><span class="line">    <span class="comment"># or it&#x27;s not composed of just digits, fail.</span></span><br><span class="line"></span><br><span class="line">    number=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    min=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    max=<span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$number</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;You didn&#x27;t enter anything. Please enter a number.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># is the first character a &#x27;-&#x27; sign</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;number%<span class="variable">$&#123;number#?&#125;</span>&#125;</span>&quot;</span> = <span class="string">&#x27;-&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">        test_value=<span class="string">&quot;<span class="variable">$&#123;number#?&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        test_value=<span class="string">&quot;<span class="variable">$&#123;number&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    no_digits=$(<span class="built_in">echo</span> <span class="variable">$test_value</span> | sed <span class="string">&#x27;s/[[:digit:]]//g&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$no_digits</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Invalid number format! only digits, no commas, spaces, etc.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$min</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Is the input less than the minimum value</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$number</span>&quot;</span> -lt <span class="string">&quot;<span class="variable">$min</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Your value is too small: smallest acceptable value is <span class="variable">$min</span>.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$max</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Is the input greater than the max value</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$number</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$max</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Your value is too big: largest value is <span class="variable">$max</span>.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> valid_int <span class="variable">$@</span> ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Input is valid integer within your contraints&quot;</span>.</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>该脚本的核心是 valid_int() 函数，其首先检查输入的 number 字符串是否为空。然后判断第一个字符是否为 -，如果是 -，则获取 - 之后的所有字符。然后检查剩余字符是否都为数字，如果不是则代表输入不是合法的整数。之后如果用户传递了 min 或 max，再检查该整数是否在其范围内</p>
<p>其使用到的 bash 脚本编程知识已经在前面的脚本中介绍过了，这里在简单总结一下:</p>
<ul>
<li>使用 if [ -z “$number” ] 判断 number 变量是否是空字符串</li>
<li>使用 ${number%${number#?}} 获取 number 字符串变量中的第一个字符</li>
<li>使用 ${number#?} 获取去除第一个字符后的剩余所有字符</li>
</ul>
<h3 id="运行-4"><a href="#运行-4" class="headerlink" title="运行"></a>运行</h3><p>以下展示了该脚本的运行结果的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ./valid_integer.sh 10 0 100</span><br><span class="line">Input is valid <span class="built_in">integer</span> within your contraints.</span><br><span class="line"></span><br><span class="line">$ ./valid_integer.sh 10 50 100</span><br><span class="line">Your value is too small: smallest acceptable value is 50.</span><br><span class="line"></span><br><span class="line">$ ./valid_integer.sh 10 0 9</span><br><span class="line">Your value is too big: largest value is 9.</span><br><span class="line"></span><br><span class="line">$ ./valid_integer.sh -1 -10 10</span><br><span class="line">Input is valid <span class="built_in">integer</span> within your contraints.</span><br><span class="line"></span><br><span class="line">$ ./valid_integer.sh -1 -20 -10</span><br><span class="line">Your value is too big: largest value is -10.</span><br><span class="line"></span><br><span class="line">$ ./valid_integer.sh -30 -20 -10</span><br><span class="line">Your value is too small: smallest acceptable value is -20.</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-4"><a href="#Hacking-4" class="headerlink" title="Hacking"></a>Hacking</h3><p>注意这个脚本不能使用逻辑 -a 来简化嵌套的 if 表达式，<strong>因为 bash 的 -a 不具有短路求值特性</strong>。这样可能会执行没有意义的比较。</p>
<h2 id="Script-6：检查浮点数输入"><a href="#Script-6：检查浮点数输入" class="headerlink" title="Script 6：检查浮点数输入"></a>Script 6：检查浮点数输入</h2><p>本脚本将对输入的浮点数进行有效性检查，可以把浮点数看成由小数点分割的两个整数，通过前一个脚本 valid_integer.sh 可以简化程序。</p>
<h3 id="代码-5"><a href="#代码-5" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"><span class="comment"># valid_float.sh</span></span><br><span class="line"><span class="comment"># Tests whether a number is a valid float-pointing value.</span></span><br><span class="line"><span class="comment"># Note this script can&#x27;t accept scientific notation.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To test whether an entered value is valid floating-point number.</span></span><br><span class="line"><span class="comment"># We need to split the value into two parts: the integer portion</span></span><br><span class="line"><span class="comment"># and the fractional portion. We test the first part to see whether</span></span><br><span class="line"><span class="comment"># it&#x27;s a valid integer, and then we test whether the second part is a</span></span><br><span class="line"><span class="comment"># valid &gt;0 integer. So -30.5 evaluates as valid, but -30.-8 doesn&#x27;t.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># To include another shell script as a part of this one, use the . source</span></span><br><span class="line"><span class="comment"># notation. Easy enough</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">. valid_integer.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">valid_float</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    fvalue=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># check whether the input number has a decimal point</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -z $(<span class="built_in">echo</span> <span class="variable">$fvalue</span> | sed <span class="string">&#x27;s/[^.]//g&#x27;</span>) ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Extract the part before the demical point</span></span><br><span class="line">        demical_part=<span class="string">&quot;<span class="subst">$(echo $fvalue | cut -d. -f1)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Extract the part after the demical point</span></span><br><span class="line">        fractional_part=<span class="variable">$&#123;fvalue#*\.&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Start by testing the demical part, which is everything to the left</span></span><br><span class="line">        <span class="comment"># of the demical point.</span></span><br><span class="line">        <span class="keyword">if</span> [ ! -z <span class="variable">$demical_part</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> ! valid_int <span class="string">&quot;<span class="variable">$demical_part</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">return</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># To start, you can&#x27;t have a negative sign after the demcial point.</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;fractional_part%<span class="variable">$&#123;fractional_part#?&#125;</span>&#125;</span>&quot;</span> = <span class="string">&quot;-&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Invalid floating-point number: &#x27;-&#x27; not allowed after demical point.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$fractional_part</span>&quot;</span> != <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> ! valid_int <span class="string">&quot;<span class="variable">$fractional_part</span>&quot;</span> <span class="string">&quot;0&quot;</span> <span class="string">&quot;&quot;</span>; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">return</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment"># if the entire value is just &quot;-&quot;, that&#x27;s not good either.</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$fvalue</span>&quot;</span> = <span class="string">&quot;-&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Invalid floating-point format.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># finally, check the remaining digits are actually</span></span><br><span class="line">        <span class="comment"># valid as integers.</span></span><br><span class="line">        <span class="keyword">if</span> ! valid_int <span class="string">&quot;<span class="variable">$fvalue</span>&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> valid_float <span class="variable">$@</span> ; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Input is valid float.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>这个脚本首先检查输入的数字是否包含小数点，如果包含小数点，则分别获取整数部分和小数部分，之后通过 valid_int 函数检查整数部分的有效性，对于小数部分，首先检查其第一个字符不能是 -，之后才可以调用 valid_int 检查小数部分的有效性。如果不包含小数点，则直接调用 valid_int 检查其有效性。</p>
<p>在这个脚本中，所涉及的知识点在前面脚本都提到过，唯一需要注意的是：</p>
<ul>
<li>通过 source 命令或 . 命令在脚本中包含其他脚本</li>
</ul>
<h3 id="运行-5"><a href="#运行-5" class="headerlink" title="运行"></a>运行</h3><p>如下展示了该脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./valid_float.sh 10.0</span><br><span class="line">Input is valid <span class="built_in">float</span>.</span><br><span class="line">$ ./valid_float.sh 0.25</span><br><span class="line">Input is valid <span class="built_in">float</span>.</span><br><span class="line">$ ./valid_float.sh -10.22</span><br><span class="line">Input is valid <span class="built_in">float</span>.</span><br><span class="line">$ ./valid_float.sh -10.-22</span><br><span class="line">Invalid floating-point number: <span class="string">&#x27;-&#x27;</span> not allowed after demical point.</span><br><span class="line">$ ./valid_float.sh -.22</span><br><span class="line">Input is valid <span class="built_in">float</span>.</span><br><span class="line">$ ./valid_float.sh 1.2ab2</span><br><span class="line">Invalid number format! only digits, no commas, spaces, etc.</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-5"><a href="#Hacking-5" class="headerlink" title="Hacking"></a>Hacking</h3><p>可以继续扩展该脚本，使其支持科学计数法。其实并不困难，只需要继续识别字符 e 或 E，然后将整个输入划分成 3 部分，每一部分都单独验证其是否是合法的整数。</p>
<h2 id="Script-7-验证日期格式"><a href="#Script-7-验证日期格式" class="headerlink" title="Script 7: 验证日期格式"></a>Script 7: 验证日期格式</h2><p>Shell 脚本编程中通常需要对用户输入的日期格式进行合法性检测。接下来的脚本将对输入的日期进行合理性检测。</p>
<h3 id="代码-6"><a href="#代码-6" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># valid_date.sh</span></span><br><span class="line"><span class="comment"># Validates a date, taking into account leap year rules.</span></span><br><span class="line"></span><br><span class="line">normal_date=<span class="string">&quot;./normalize_date.sh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">exceed_days_in_month</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Give a month name and day number in that month, this function will return 0</span></span><br><span class="line">    <span class="comment"># if the specified day value is less than or equal to the max days in month,</span></span><br><span class="line">    <span class="comment"># 1 otherwise</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;<span class="subst">$(echo $1 | tr &#x27;[:upper:]&#x27; &#x27;[:lower:]&#x27;)</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">        jan*)   days=31 ;;</span><br><span class="line">        feb*)   days=28 ;;</span><br><span class="line">        mar*)   days=31 ;;</span><br><span class="line">        apr*)   days=30 ;;</span><br><span class="line">        may*)   days=31 ;;</span><br><span class="line">        jun*)   days=30 ;;</span><br><span class="line">        jul*)   days=31 ;;</span><br><span class="line">        aug*)   days=31 ;;</span><br><span class="line">        sep*)   days=30 ;;</span><br><span class="line">        oct*)   days=31 ;;</span><br><span class="line">        nov*)   days=30 ;;</span><br><span class="line">        dec*)   days=31 ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$2</span> -le 0 -o <span class="variable">$2</span> -gt <span class="variable">$days</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_leap_year</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    year=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$((year % 4 )</span>)&quot;</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="subst">$((year % 400)</span>)&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="subst">$((year % 100)</span>)&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># begin main script</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 3 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> month day year&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Typical input formats are Auguest 3 1962 and 8 3 1962&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># call normal_date script to normalize date format</span></span><br><span class="line">new_date=<span class="string">&quot;<span class="subst">$($normal_date <span class="string">&quot;<span class="variable">$@</span>&quot;</span>)</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 1 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">month=<span class="string">&quot;<span class="subst">$(echo $new_date | cut -d\  -f1)</span>&quot;</span></span><br><span class="line">day=<span class="string">&quot;<span class="subst">$(echo $new_date | cut -d\  -f2)</span>&quot;</span></span><br><span class="line">year=<span class="string">&quot;<span class="subst">$(echo $new_date | cut -d\  -f3)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! exceed_days_in_month <span class="string">&quot;<span class="variable">$month</span>&quot;</span> <span class="string">&quot;<span class="variable">$2</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$month</span>&quot;</span> = <span class="string">&quot;Feb&quot;</span> -a <span class="string">&quot;<span class="variable">$2</span>&quot;</span> -eq 29 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ! is_leap_year <span class="string">&quot;<span class="variable">$year</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: <span class="variable">$3</span> is not a leap year, so Feb doesn&#x27;t have 29 days.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: bad day value: <span class="variable">$month</span> doesn&#x27;t have <span class="variable">$2</span> days.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Valid date: <span class="variable">$new_date</span>&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h3><p>该脚本对输入的日期进行合法性检查，检查每个月的天数是否合法，并将闰年的情况考虑进来。<code>exceed_days_in_month</code> 用于根据月份获取天数，函数 <code>is_leap_year</code> 用于判断年份是否是闰年。</p>
<p>脚本首先使用之前的脚本 normalize_date.sh 来对输入的日期进行格式化，然后获取输入的年、月、日。调用 exceed_days_in_month 来检查输入的月份、天数是否合理，如果返回 false，则进一步检查是否是闰年的二月，从而进行特殊处理。</p>
<h3 id="运行-6"><a href="#运行-6" class="headerlink" title="运行"></a>运行</h3><p>以下是这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ sh valid_date.sh 2 30 2000</span><br><span class="line">valid_date.sh: bad day value: Feb doesn<span class="string">&#x27;t have 30 days.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sh valid_date.sh 2 29 1996</span></span><br><span class="line"><span class="string">Valid date: Feb 29 1996</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sh valid_date.sh 2 29 2000</span></span><br><span class="line"><span class="string">Valid date: Feb 29 2000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sh valid_date.sh 2 29 2001</span></span><br><span class="line"><span class="string">valid_date.sh: 2001 is not a leap year, so Feb doesn&#x27;</span>t have 29 days.</span><br><span class="line"></span><br><span class="line">$ sh valid_date.sh 2 28 2001</span><br><span class="line">Valid <span class="built_in">date</span>: Feb 28 2001</span><br><span class="line"></span><br><span class="line">$ sh valid_date.sh 5 32 2001</span><br><span class="line">valid_date.sh: bad day value: May doesn<span class="string">&#x27;t have 32 days.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ sh valid_date.sh 6 31 2001</span></span><br><span class="line"><span class="string">valid_date.sh: bad day value: Jun doesn&#x27;</span>t have 31 days.</span><br><span class="line"></span><br><span class="line">$ sh valid_date.sh 6 30 2001</span><br><span class="line">Valid <span class="built_in">date</span>: Jun 30 2001</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-6"><a href="#Hacking-6" class="headerlink" title="Hacking"></a>Hacking</h3><p>这里介绍一种非常特别的方式来判断某一年是否是闰年：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">is_leap</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    year=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ $(<span class="built_in">date</span> -d <span class="string">&quot;12/31/<span class="variable">$year</span>&quot;</span> +%j) = <span class="string">&quot;366&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里用到了 date 命令，-d 选项用来指定日期，而 +%j 用于输出指定日期在这一年中的天数，这样，如果一年的最后一天是 366，则代表是闰年，否则不是闰年。</p>
<h2 id="Script-8：重新实现-echo"><a href="#Script-8：重新实现-echo" class="headerlink" title="Script 8：重新实现 echo"></a>Script 8：重新实现 echo</h2><p>不同 Unix 以及 GNU&#x2F;Linux 版本对 echo 命令的实现有所不同，例如有的版本支持通过 -n 选项来禁止输出换行符，但有的版本不支持该选项，另外有的版本可以通过 \c 控制符来禁止输出换行符，而有的版本总是输出换行符。</p>
<p>例如，我的 CentOS7 的 echo 命令支持 -n 选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">&quot;The rain in Spain&quot;</span>; <span class="built_in">echo</span> <span class="string">&quot; falls mainly on the Plain&quot;</span></span><br><span class="line">The rain <span class="keyword">in</span> Spain falls mainly on the Plain</span><br></pre></td></tr></table></figure>

<p>为了确保脚本中调用的 echo 命令在各个平台上行为一致，将创建 echo 命令的替代版本：命令 echon。其总是禁止输出换行符。</p>
<h3 id="代码-7"><a href="#代码-7" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echon.sh</span></span><br><span class="line"><span class="comment"># An alternative version, which always suppress the trailing newline.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">echon</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span> | awk <span class="string">&#x27;&#123; printf &quot;%s&quot;, $0 &#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    echon <span class="string">&quot;this is a line1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h3><p>这个脚本的 echon 函数使用 awk 的 printf 进行输出，其中 <code>$0</code> 代表整个输入行。如果你不想使用 awk 命令，也可以直接使用系统的 printf 命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">echon</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span> <span class="string">&quot;%s&quot;</span> <span class="string">&quot;$*&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>printf 命令总是按照指定格式输出参数，并不会自动添加换行符。</p>
<h3 id="运行-7"><a href="#运行-7" class="headerlink" title="运行"></a>运行</h3><p>如下是该脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[fuchencong@CentOS7-1 Chapter_01]$ ./echon.sh</span><br><span class="line">this is a line1[fuchencong@CentOS7-1 Chapter_01]$</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-7"><a href="#Hacking-7" class="headerlink" title="Hacking"></a>Hacking</h3><p>可以的测试你系统 echo 命令处理换行符的行为，例如通过执行 echo -n hi | wc -c，如果返回值是 2，则代表系统的 echo 命令可以识别 -n 选项，不输出换行符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[fuchencong@CentOS7-1 Chapter_01]$ <span class="built_in">echo</span> -n hi | <span class="built_in">wc</span> -c</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h2 id="Script-9：任意精度的浮点数运算"><a href="#Script-9：任意精度的浮点数运算" class="headerlink" title="Script 9：任意精度的浮点数运算"></a>Script 9：任意精度的浮点数运算</h2><p>在 Bash 脚本中通常使用 <code>$(())</code> 进行算术运算，该表达式支持加、减、乘、除、求余等基本算术操作。但是其仅支持整型操作，不支持浮点数运算。如果想要进行浮点数运算，可以使用 bc 命令，bc 提供任意精度的浮点数运算，本脚本将对 bc 命令进行简单的包装。</p>
<h3 id="代码-8"><a href="#代码-8" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># scriptbc.sh</span></span><br><span class="line"><span class="comment"># Wrapper for &#x27;bc&#x27; than returns the result of a caculation</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&quot;-p&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    precision=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">shift</span> 2</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    precision=2 <span class="comment">#default</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bc -q -l &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">    scale=$precision</span></span><br><span class="line"><span class="string">    $*</span></span><br><span class="line"><span class="string">    quit</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h3><p>这个脚本只是对 bc 命令进行简单地包装。首先该脚本支持通过 <code>-p</code> 选项设置运算精度，如果没有指定精度，则默认为 2。之后调用 bc 命令进行运算，bc 命令从标准输入中读取数据进行运算。</p>
<p>这个脚本中，通过 &lt;&lt; 来包含输入，在 EOF 之间的所有内容都被传入 bc 命令，就好像是从标准输入中读取的一样。<strong>这种语法称为 HERE 文档</strong>。这里不一定要使用 EOF 字符串，可以使用任意字符串，只需要保证前后一致即可。</p>
<p>bc 命令默认精度为 0，因此其工作方式和 $(()) 一致。可以通过 scale&#x3D;value 的方式设置精度。另外，bc 的 <code>-q</code> 选项用于启动时不打印信息，<code>-l</code> 用于定义标准数学库。</p>
<p>$* 表示所有命令行参数，这里就是把输入参数传入 bc 命令进行运算，最后通过 quit 退出 bc。</p>
<h3 id="运行-8"><a href="#运行-8" class="headerlink" title="运行"></a>运行</h3><p>以下展示了这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./scriptbc.sh 10 / 2</span><br><span class="line">5.00</span><br><span class="line">$ ./scriptbc.sh -p 5 10 / 2</span><br><span class="line">5.00000</span><br><span class="line">$ ./scriptbc.sh -p 3 10 / 3</span><br><span class="line">3.333</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-8"><a href="#Hacking-8" class="headerlink" title="Hacking"></a>Hacking</h3><p>该脚本主要是对 bc 命令进行包装，bc 命令从标准输入中读取数据进行运算，这里通过 <code>HERE 文档</code> 的方式将命令行参数转换为 bc 命令的输入数据。</p>
<h2 id="Script-10：对文件上锁"><a href="#Script-10：对文件上锁" class="headerlink" title="Script 10：对文件上锁"></a>Script 10：对文件上锁</h2><p>当一个脚本尝试读取或者修改文件时，最好对该文件上锁，这样就可以避免其他脚本同时操作该文件。对文件上锁最常用的方法是创建一个独立的 lock file。该 lock file 充当信号量的作用，用于表示所保护的文件是否正在被其它进程使用。</p>
<p>但是这并不容易，例如如下的方案无法解决这个问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> [ -f <span class="variable">$lockfile</span> ]; <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">touch</span> <span class="variable">$lockfile</span></span><br></pre></td></tr></table></figure>

<p>这段代码不停循环检测 lockfile 是否存在，如果 lockfile 存在则代表其它脚本正在使用所保护的文件，如果不存在，则可以安心地使用所保护的文件，并创建 lockfile，使用完毕之后再删除 lockfile。</p>
<p>稍微了解多线程编程知识就应该明白这样做是会出问题的，现代操作系统都支持多道程序设计，检查 lockfile 和创建 lockfile 并不是一个原子操作，如果有多个脚本同时运行并竞争 lockfile 时，此时可能会出现同步问题。</p>
<p>现在很多 Unix 版本，包括 GNU&#x2F;Linux 都支持一个命令行工具：lockfile，可以让你安全可靠地在 shell 脚本中对文件加锁。如果你的系统中没有 lockfile 命令，可以安装 procmail 软件包:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install procmail</span><br></pre></td></tr></table></figure>

<p>如下脚本是对 lockfile 的简单包装，简化 lockfile 的使用。</p>
<h3 id="代码-9"><a href="#代码-9" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># filelock</span></span><br><span class="line"><span class="comment"># A flexible file-locking mechanism</span></span><br><span class="line"></span><br><span class="line">retries=<span class="string">&quot;10&quot;</span></span><br><span class="line">action=<span class="string">&quot;lock&quot;</span></span><br><span class="line">nullcmd=<span class="string">&quot;which true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;lur:&quot;</span> opt; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$opt</span> <span class="keyword">in</span></span><br><span class="line">    l ) action=<span class="string">&quot;lock&quot;</span>       ;;</span><br><span class="line">    u ) action=<span class="string">&quot;unlock&quot;</span>     ;;</span><br><span class="line">    r ) retries=<span class="string">&quot;<span class="variable">$OPTARG</span>&quot;</span>   ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">shift</span> $((<span class="variable">$OPTIND</span> - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">        Usage: $0 [-l|-u] [-r retries] LOCKFILE</span></span><br><span class="line"><span class="string">        Where -l request a lock(the default), -u request an unlock, -r X</span></span><br><span class="line"><span class="string">        specifies a max number of retries before it fails (default= $retries).</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="subst">$(which lockfile | grep -v &#x27;^no &#x27;)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span> failed: &#x27;lockfile&#x27; utility not found in PATH.&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$action</span>&quot;</span> = <span class="string">&quot;lock&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> ! lockfile -r <span class="string">&quot;<span class="variable">$retries</span>&quot;</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> 2&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: Failed: Couldn&#x27;t create lockfile in <span class="variable">$retries</span> times.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -f <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$0</span>: Warning: lockfile <span class="variable">$1</span> doesn&#x27;t exit to unlock.&quot;</span> &gt;&amp;2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-9"><a href="#原理-9" class="headerlink" title="原理"></a>原理</h3><p>这个脚本最核心的就是使用 lockfile 命令来锁文件。如果 lockfile 无法创建指定的锁文件，它会等待一段时间（默认为 8 s）然后继续尝试。可以通过 -r 选项指定尝试次数，如果达到了指定重试次数仍然无法创建成功，则 lockfile 返回失败。在这个脚本中，如果是加锁，则使用 lockfile 命令创建锁文件，如果是解锁，则调用 rm 命令删除锁文件。</p>
<p>其他涉及的知识已经在前面的脚本介绍过：</p>
<ul>
<li>使用 getopt 命令完成命令行参数解析</li>
<li>使用 HERE 文档将脚本中的字符串转化为 cat 命令的标准输入</li>
</ul>
<h3 id="运行-9"><a href="#运行-9" class="headerlink" title="运行"></a>运行</h3><p>如下展示了这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ./filelock.sh -l test.lock</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -l test.lock</span><br><span class="line">-r--r--r--. 1 fuchencong fuchencong 1 May 11 15:02 test.lock</span><br><span class="line"></span><br><span class="line">$ ./filelock.sh -l test.lock</span><br><span class="line">./filelock.sh: Failed: Couldn<span class="string">&#x27;t create lockfile in 10 times.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ./filelock.sh -u test.lock</span></span><br><span class="line"><span class="string">$ ls -l test.lock</span></span><br><span class="line"><span class="string">ls: cannot access test.lock: No such file or directory</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ ./filelock.sh -l test.lock</span></span><br></pre></td></tr></table></figure>

<p>可以看到，第一次成功创建锁文件 test.lock，之后再次创建该锁文件，则脚本被阻塞，直到 10 次尝试失败打印错误消息。而解锁之后，test.lock 则被删除，再次创建该锁文件则直接成功。</p>
<h3 id="Hacking-9"><a href="#Hacking-9" class="headerlink" title="Hacking"></a>Hacking</h3><p>在使用 lockfile 命令时最好通过 -l 选项来指定最长锁定时间，这样可以避免某个脚本在加锁之后忘记解锁，而造成其他脚本永远无法加锁成功。</p>
<h2 id="Script-11：ANSI-颜色序列"><a href="#Script-11：ANSI-颜色序列" class="headerlink" title="Script 11：ANSI 颜色序列"></a>Script 11：ANSI 颜色序列</h2><p>大多数终端应用程序支持不同的风格来表现文本，例如可以让某些文本使用粗体、或者红色显示。但是，在使用 ANSI（American National Standards Institute）序列来控制文本的风格时，会有点困难，因为这些控制字符串对程序员而言并不友好，本脚本将会简化这些控制字符串的使用。</p>
<h3 id="代码-10"><a href="#代码-10" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ansi_color.sh</span></span><br><span class="line"><span class="comment"># Use these variables to make output in different colors and formats.</span></span><br><span class="line"><span class="comment"># Color names that end with f are foreground colors, and those ending</span></span><br><span class="line"><span class="comment"># with &#x27;b&#x27; are background colors.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">initialize_ansi</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    esc=<span class="string">&#x27;\033&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Foreground colors</span></span><br><span class="line">    blackf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[30m&quot;</span></span><br><span class="line">    yellowf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[33m&quot;</span></span><br><span class="line">    cyanf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[36m&quot;</span></span><br><span class="line">    redf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[31m&quot;</span></span><br><span class="line">    greenf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[32m&quot;</span></span><br><span class="line">    bluef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[34m&quot;</span></span><br><span class="line">    purplef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[35m&quot;</span></span><br><span class="line">    whitef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[37m&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Background colors</span></span><br><span class="line">    blackb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[40m&quot;</span></span><br><span class="line">    yellowb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[43m&quot;</span></span><br><span class="line">    cyanb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[46m&quot;</span></span><br><span class="line">    redb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[41m&quot;</span></span><br><span class="line">    greenb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[42m&quot;</span></span><br><span class="line">    blueb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[44m&quot;</span></span><br><span class="line">    purpleb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[45m&quot;</span></span><br><span class="line">    whiteb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[47m&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Bold, italic, underline, and inverse style toggles</span></span><br><span class="line">    boldon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[1m&quot;</span></span><br><span class="line">    boldoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[22m&quot;</span></span><br><span class="line">    italicson=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[3m&quot;</span></span><br><span class="line">    italicsoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[23m&quot;</span></span><br><span class="line">    ulon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[4m&quot;</span></span><br><span class="line">    uloff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[24m&quot;</span></span><br><span class="line">    invon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[7m&quot;</span></span><br><span class="line">    invoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[27m&quot;</span></span><br><span class="line"></span><br><span class="line">    reset=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[0m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    initialize_ansi</span><br><span class="line"></span><br><span class="line">    str=<span class="string">&quot;</span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;yellowf&#125;</span>This is a phrase in yellow<span class="variable">$&#123;redb&#125;</span> and red<span class="variable">$&#123;reset&#125;</span></span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;boldon&#125;</span>This is bold<span class="variable">$&#123;ulon&#125;</span> this is italics<span class="variable">$&#123;reset&#125;</span> bye-bye</span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;italicson&#125;</span>This is italics<span class="variable">$&#123;italicsoff&#125;</span> and this is not</span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;ulon&#125;</span>This is ul<span class="variable">$&#123;uloff&#125;</span> and this is not</span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;invon&#125;</span>This is inv<span class="variable">$&#123;invoff&#125;</span> and this is not</span></span><br><span class="line"><span class="string">    <span class="variable">$&#123;yellowf&#125;</span><span class="variable">$&#123;redb&#125;</span>Warning I <span class="variable">$&#123;yellowb&#125;</span><span class="variable">$&#123;redf&#125;</span>Warning II<span class="variable">$&#123;reset&#125;</span></span></span><br><span class="line"><span class="string">    &quot;</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$str</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BASH_SOURCE</span>&quot;</span> = <span class="string">&quot;<span class="variable">$0</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">test</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="原理-10"><a href="#原理-10" class="headerlink" title="原理"></a>原理</h3><p>这个脚本在函数 <code>initialize_ansi</code> 中定义了许多变量，这些变量的值就是各种 ANSI 控制序列，之后就可以直接使用这些变量来控制文本的格式，这简化了对 ANSI 控制序列的使用。</p>
<p>在这些变量中，可以进行效果叠加，也可以通过 on&#x2F;off 进行 开启&#x2F;关闭，而所有格式都可以通过 reset 进行清除。</p>
<p>另外，在使用输出命令时，需要该命令支持 ANSI 控制序列才能得到相应的输出效果，例如使用 echo 时需要使用 -e 选项。</p>
<h3 id="运行-10"><a href="#运行-10" class="headerlink" title="运行"></a>运行</h3><p>如下展示了这个脚本的运行结果：</p>
<img src="/fuchencong.github.io/2019/07/14/shell-script-101-02/images/01-color.png" class="">

<h3 id="Hacking-10"><a href="#Hacking-10" class="headerlink" title="Hacking"></a>Hacking</h3><p>这个脚本的输出还需要你的终端支持 ANSI 序列。</p>
<h2 id="Script-12：构建一个-Shell-脚本库"><a href="#Script-12：构建一个-Shell-脚本库" class="headerlink" title="Script 12：构建一个 Shell 脚本库"></a>Script 12：构建一个 Shell 脚本库</h2><p>本章中的很多脚本都被编写成函数形式，而不是一个独立运行的程序，这样这些脚本就可以轻易地被集成到其他脚本中使用。在脚本中包含其他脚本，和在脚本中调用其他脚本是不一样的。如下展示了一个重要区别：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;test=2&quot;</span> &gt;&gt; tinyscript.sh</span><br><span class="line">$ <span class="built_in">chmod</span> +x tinyscript.sh</span><br><span class="line">$ <span class="built_in">test</span>=1</span><br><span class="line">$ ./tinyscript.sh</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$test</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>因为是在一个子 shell 中运行 tinyscript.sh，所以当前 shell 环境中的 test 变量并没有修改。但是如果使用 . 或 source 命令来包含 tinyscript.sh，这就如同将 tinyscript.sh 中的命令直接输入当前 shell 中执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> tinyscript.sh</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$test</span></span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<p>接下来将本章所编写的几个功能函数以及所需的全局变量都包含到 library.sh，然后在一个示例脚本中使用这个库文件。</p>
<h3 id="代码-11"><a href="#代码-11" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># library.sh</span></span><br><span class="line"><span class="comment"># include all tool functions</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">initialize_ansi</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    esc=<span class="string">&#x27;\033&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Foreground colors</span></span><br><span class="line">    blackf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[30m&quot;</span></span><br><span class="line">    yellowf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[33m&quot;</span></span><br><span class="line">    cyanf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[36m&quot;</span></span><br><span class="line">    redf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[31m&quot;</span></span><br><span class="line">    greenf=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[32m&quot;</span></span><br><span class="line">    bluef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[34m&quot;</span></span><br><span class="line">    purplef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[35m&quot;</span></span><br><span class="line">    whitef=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[37m&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Background colors</span></span><br><span class="line">    blackb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[40m&quot;</span></span><br><span class="line">    yellowb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[43m&quot;</span></span><br><span class="line">    cyanb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[46m&quot;</span></span><br><span class="line">    redb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[41m&quot;</span></span><br><span class="line">    greenb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[42m&quot;</span></span><br><span class="line">    blueb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[44m&quot;</span></span><br><span class="line">    purpleb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[45m&quot;</span></span><br><span class="line">    whiteb=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[47m&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Bold, italic, underline, and inverse style toggles</span></span><br><span class="line">    boldon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[1m&quot;</span></span><br><span class="line">    boldoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[22m&quot;</span></span><br><span class="line">    italicson=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[3m&quot;</span></span><br><span class="line">    italicsoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[23m&quot;</span></span><br><span class="line">    ulon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[4m&quot;</span></span><br><span class="line">    uloff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[24m&quot;</span></span><br><span class="line">    invon=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[7m&quot;</span></span><br><span class="line">    invoff=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[27m&quot;</span></span><br><span class="line"></span><br><span class="line">    reset=<span class="string">&quot;<span class="variable">$&#123;esc&#125;</span>[0m&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">echon</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span> | awk <span class="string">&#x27;&#123; printf &quot;%s&quot;, $0 &#125;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">in_path</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Given a command and the PATH, tries to find the command.</span></span><br><span class="line">    <span class="comment"># Returns 0 if found the executable. 1 if not.</span></span><br><span class="line">    <span class="comment"># Note that this temporarily modifies the IFS (internal field separator)</span></span><br><span class="line">    <span class="comment"># but restores it upon completion</span></span><br><span class="line"></span><br><span class="line">    cmd=<span class="variable">$1</span></span><br><span class="line">    ourpath=<span class="variable">$2</span></span><br><span class="line">    result=1</span><br><span class="line"></span><br><span class="line">    oldIFS=IFS</span><br><span class="line">    IFS=<span class="string">&quot;:&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> directory <span class="keyword">in</span> <span class="variable">$ourpath</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> [ -x <span class="variable">$directory</span>/<span class="variable">$cmd</span> ]; <span class="keyword">then</span></span><br><span class="line">            result=0    <span class="comment"># if we&#x27;re here, we found the command</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    IFS=<span class="variable">$oldIFS</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$result</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_cmd_in_path</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    var=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$var</span>&quot;</span> != <span class="string">&quot;&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;var:0:1&#125;</span>&quot;</span> = <span class="string">&quot;/&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ ! -x <span class="variable">$var</span> ]; <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">return</span> 1</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">elif</span> ! in_path <span class="variable">$var</span> <span class="string">&quot;<span class="variable">$PATH</span>&quot;</span> ; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 2</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">valid_int</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># Validate first field and test the value against min value $2 and/or</span></span><br><span class="line">    <span class="comment"># max value $3 if they are supplied. If the value isn&#x27;t within range</span></span><br><span class="line">    <span class="comment"># or it&#x27;s not composed of just digits, fail.</span></span><br><span class="line"></span><br><span class="line">    number=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    min=<span class="string">&quot;<span class="variable">$2</span>&quot;</span></span><br><span class="line">    max=<span class="string">&quot;<span class="variable">$3</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$number</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;You didn&#x27;t enter anything. Please enter a number.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># is the first character a &#x27;-&#x27; sign</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;number%<span class="variable">$&#123;number#?&#125;</span>&#125;</span>&quot;</span> = <span class="string">&#x27;-&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">        test_value=<span class="string">&quot;<span class="variable">$&#123;number#?&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        test_value=<span class="string">&quot;<span class="variable">$&#123;number&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    no_digits=$(<span class="built_in">echo</span> <span class="variable">$test_value</span> | sed <span class="string">&#x27;s/[[:digit:]]//g&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$no_digits</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Invalid number format! only digits, no commas, spaces, etc.&quot;</span> &gt;&amp;2</span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$min</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Is the input less than the minimum value</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$number</span>&quot;</span> -lt <span class="string">&quot;<span class="variable">$min</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Your value is too small: smallest acceptable value is <span class="variable">$min</span>.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$max</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># Is the input greater than the max value</span></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$number</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$max</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Your value is too big: largest value is <span class="variable">$max</span>.&quot;</span> &gt;&amp;2</span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">is_leap_year</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    year=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$((year % 4 )</span>)&quot;</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="subst">$((year % 400)</span>)&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="subst">$((year % 100)</span>)&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright (C) fuchencong.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># use_library.sh</span></span><br><span class="line"><span class="comment"># test library.sh</span></span><br><span class="line"></span><br><span class="line">. library.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># set up all those ANSI escape sequences.</span></span><br><span class="line">initialize_ansi</span><br><span class="line"></span><br><span class="line">echon <span class="string">&quot;First off, do you have echo in your path? (1=yes, 2=no)&quot;</span></span><br><span class="line"><span class="built_in">read</span> answer</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ! valid_int <span class="variable">$answer</span> 1 2; <span class="keyword">do</span></span><br><span class="line">    echon -e <span class="string">&quot;<span class="variable">$&#123;boldon&#125;</span>Try again<span class="variable">$&#123;boldoff&#125;</span>. Do you have echo &quot;</span></span><br><span class="line">    echon -e <span class="string">&quot;in your path? (1=yes, 2=no) &quot;</span></span><br><span class="line">    <span class="built_in">read</span> answer</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check echo if in PATH</span></span><br><span class="line"><span class="keyword">if</span> ! check_cmd_in_path <span class="string">&quot;echo&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Nope, can&#x27;t find the echo command&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;The echo command is in the PATH&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Enter a year you think might is a leap year&quot;</span></span><br><span class="line"><span class="built_in">read</span> year</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ! valid_int <span class="variable">$year</span> 1 9999; <span class="keyword">do</span></span><br><span class="line">    echon -e <span class="string">&quot;Please enter a year in the <span class="variable">$&#123;boldon&#125;</span>correct<span class="variable">$&#123;boldoff&#125;</span> format:&quot;</span></span><br><span class="line">    <span class="built_in">read</span> year</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> is_leap_year <span class="variable">$year</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;greenf&#125;</span>You&#x27;re right! <span class="variable">$year</span> is leap year.<span class="variable">$&#123;reset&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;redf&#125;</span>Nope! <span class="variable">$year</span> is not a leap year.<span class="variable">$&#123;reset&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-11"><a href="#原理-11" class="headerlink" title="原理"></a>原理</h3><p>use_library.sh 脚本首先使用 . 命令包含 library.sh，这样就可以在这个脚本中使用 library.sh 中的各个函数了。</p>
<h3 id="运行-11"><a href="#运行-11" class="headerlink" title="运行"></a>运行</h3><p>如下展示了这个脚本的运行结果：</p>
<img src="/fuchencong.github.io/2019/07/14/shell-script-101-02/images/01-library-1.png" class="">

<h3 id="Hacking-11"><a href="#Hacking-11" class="headerlink" title="Hacking"></a>Hacking</h3><p>可以不停拓展 library.sh，这样就可以构建出自己的脚本库文件，简化后续脚本的编写。</p>
<h2 id="Script-13：调试-Shell-脚本"><a href="#Script-13：调试-Shell-脚本" class="headerlink" title="Script 13：调试 Shell 脚本"></a>Script 13：调试 Shell 脚本</h2><p>这一节将介绍一些基本的 Shell 脚本调试技巧。首先最好的调试策略就是增量构建 Shell 脚本。另外，可以充分使用 echo 命令来跟踪变量，也可以使用 bash -x 来打印调试结果。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -x test.sh</span><br></pre></td></tr></table></figure>

<p>或者也可以使用 set -x 打开 bash 的调试选项，之后再使用 set +x 关闭调试开关。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">set</span> -x</span><br><span class="line">$ ./test.sh</span><br><span class="line">$ <span class="built_in">set</span> +x</span><br></pre></td></tr></table></figure>

<h3 id="代码-12"><a href="#代码-12" class="headerlink" title="代码"></a>代码</h3><p>以下展示了一个猜数字游戏的简单脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># guess_number.sh</span></span><br><span class="line"><span class="comment"># A simple guess number game</span></span><br><span class="line"></span><br><span class="line">biggest=100</span><br><span class="line">guess=0</span><br><span class="line">guesses=0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Random number, between 1 and $biggest</span></span><br><span class="line">number=$(( $$ % <span class="variable">$biggest</span> ))</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Guess a number between 1 and <span class="variable">$biggest</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ <span class="string">&quot;<span class="variable">$guess</span>&quot;</span> -ne <span class="string">&quot;<span class="variable">$number</span>&quot;</span> ]; <span class="keyword">do</span></span><br><span class="line">    /bin/echo -n <span class="string">&quot;Guess? &quot;</span>;</span><br><span class="line">    <span class="built_in">read</span> guess</span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$guess</span>&quot;</span> -lt <span class="string">&quot;<span class="variable">$number</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;...smaller&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$guess</span>&quot;</span> -gt <span class="string">&quot;<span class="variable">$number</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;...bigger&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    guesses=$(( <span class="variable">$guesses</span> + <span class="number">1</span> ))</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Rignt!! Guessed <span class="variable">$number</span> in <span class="variable">$guesses</span> guesses.&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<h3 id="原理-12"><a href="#原理-12" class="headerlink" title="原理"></a>原理</h3><p>这个脚本唯一需要注意的是使用 <code>$$</code> 来获得一个随机数，在 bash 脚本中，$$ 是当前进程的 ID，即运行当前脚本的进程 ID。每次运行脚本，进程 ID 是不同的，从而间接得到一个随机数。</p>
<p>另外一种获取随机数的方法是使用环境变量 $RANDOM，例如如果要获取 1 - 100 之间的随机数，可以通过如下方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $(( <span class="variable">$RANDOM</span> % <span class="number">100</span> + <span class="number">1</span> ))</span><br><span class="line">28</span><br><span class="line">$ <span class="built_in">echo</span> $(( <span class="variable">$RANDOM</span> % <span class="number">100</span> + <span class="number">1</span> ))</span><br><span class="line">24</span><br><span class="line">$ <span class="built_in">echo</span> $(( <span class="variable">$RANDOM</span> % <span class="number">100</span> + <span class="number">1</span> ))</span><br><span class="line">76</span><br><span class="line">$ <span class="built_in">echo</span> $(( <span class="variable">$RANDOM</span> % <span class="number">100</span> + <span class="number">1</span> ))</span><br><span class="line">26</span><br></pre></td></tr></table></figure>

<h3 id="运行-12"><a href="#运行-12" class="headerlink" title="运行"></a>运行</h3><p>以下展示了这个脚本的运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ./guess_number.sh</span><br><span class="line">Guess a number between 1 and 100</span><br><span class="line">Guess? 50</span><br><span class="line">...bigger</span><br><span class="line">Guess? 25</span><br><span class="line">...smaller</span><br><span class="line">Guess? 32</span><br><span class="line">...smaller</span><br><span class="line">Guess? 40</span><br><span class="line">...smaller</span><br><span class="line">Guess? 45</span><br><span class="line">...smaller</span><br><span class="line">Guess? 48</span><br><span class="line">...bigger</span><br><span class="line">Guess? 46</span><br><span class="line">...smaller</span><br><span class="line">Guess? 47</span><br><span class="line">Rignt!! Guessed 47 <span class="keyword">in</span> 8 guesses.</span><br></pre></td></tr></table></figure>

<h3 id="Hacking-12"><a href="#Hacking-12" class="headerlink" title="Hacking"></a>Hacking</h3><p>在编写脚本时，通常碰到的一个语法错误是双引号没有成对出现，这里提供一个小技巧，快速找到这类语法错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sh guess_number.sh</span><br><span class="line">Guess a number between 1 and 100</span><br><span class="line">guess_number.sh: line 26: unexpected EOF <span class="keyword">while</span> looking <span class="keyword">for</span> matching `<span class="string">&quot;&#x27;</span></span><br><span class="line"><span class="string">guess_number.sh: line 30: syntax error: unexpected end of file</span></span><br><span class="line"><span class="string">$ grep &#x27;&quot;</span><span class="string">&#x27; guess_number.sh  | egrep -v &#x27;</span>.*<span class="string">&quot;.*&quot;</span>.*<span class="string">&#x27;</span></span><br><span class="line"><span class="string">        echo &quot;...bigger</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/fuchencong.github.io/tags/Bash/" rel="tag"># Bash</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2019/11/22/my-life-03/" rel="prev" title="光谷买房记">
      <i class="fa fa-chevron-left"></i> 光谷买房记
    </a></div>
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2019/07/13/shell-script-101-01/" rel="next" title="Shell 脚本 101（1）：开启 Shell 编程之旅">
      Shell 脚本 101（1）：开启 Shell 编程之旅 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#POSIX-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.</span> <span class="nav-text">POSIX 是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-1%EF%BC%9A%E5%9C%A8-PATH-%E4%B8%AD%E6%9F%A5%E6%89%BE%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.</span> <span class="nav-text">Script 1：在 PATH 中查找程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-number">2.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">2.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking"><span class="nav-number">2.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-2%EF%BC%9A%E6%A3%80%E6%9F%A5%E8%BE%93%E5%85%A5%EF%BC%8C%E5%8F%AA%E6%8E%A5%E5%8F%97%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D"><span class="nav-number">3.</span> <span class="nav-text">Script 2：检查输入，只接受数字和字母</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="nav-number">3.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-1"><span class="nav-number">3.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-1"><span class="nav-number">3.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-1"><span class="nav-number">3.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-3%EF%BC%9A%E6%A0%87%E5%87%86%E5%8C%96%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.</span> <span class="nav-text">Script 3：标准化日期格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="nav-number">4.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-2"><span class="nav-number">4.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-2"><span class="nav-number">4.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-2"><span class="nav-number">4.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-4%EF%BC%9A%E6%A0%BC%E5%BC%8F%E5%8F%8B%E5%A5%BD%E5%9C%B0%E8%BE%93%E5%87%BA%E5%A4%A7%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text">Script 4：格式友好地输出大数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="nav-number">5.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-3"><span class="nav-number">5.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-3"><span class="nav-number">5.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-3"><span class="nav-number">5.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-5%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%95%B4%E6%95%B0%E8%BE%93%E5%85%A5"><span class="nav-number">6.</span> <span class="nav-text">Script 5：检查整数输入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-4"><span class="nav-number">6.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-4"><span class="nav-number">6.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-4"><span class="nav-number">6.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-4"><span class="nav-number">6.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-6%EF%BC%9A%E6%A3%80%E6%9F%A5%E6%B5%AE%E7%82%B9%E6%95%B0%E8%BE%93%E5%85%A5"><span class="nav-number">7.</span> <span class="nav-text">Script 6：检查浮点数输入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-5"><span class="nav-number">7.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-5"><span class="nav-number">7.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-5"><span class="nav-number">7.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-5"><span class="nav-number">7.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-7-%E9%AA%8C%E8%AF%81%E6%97%A5%E6%9C%9F%E6%A0%BC%E5%BC%8F"><span class="nav-number">8.</span> <span class="nav-text">Script 7: 验证日期格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-6"><span class="nav-number">8.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-6"><span class="nav-number">8.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-6"><span class="nav-number">8.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-6"><span class="nav-number">8.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-8%EF%BC%9A%E9%87%8D%E6%96%B0%E5%AE%9E%E7%8E%B0-echo"><span class="nav-number">9.</span> <span class="nav-text">Script 8：重新实现 echo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-7"><span class="nav-number">9.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-7"><span class="nav-number">9.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-7"><span class="nav-number">9.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-7"><span class="nav-number">9.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-9%EF%BC%9A%E4%BB%BB%E6%84%8F%E7%B2%BE%E5%BA%A6%E7%9A%84%E6%B5%AE%E7%82%B9%E6%95%B0%E8%BF%90%E7%AE%97"><span class="nav-number">10.</span> <span class="nav-text">Script 9：任意精度的浮点数运算</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-8"><span class="nav-number">10.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-8"><span class="nav-number">10.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-8"><span class="nav-number">10.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-8"><span class="nav-number">10.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-10%EF%BC%9A%E5%AF%B9%E6%96%87%E4%BB%B6%E4%B8%8A%E9%94%81"><span class="nav-number">11.</span> <span class="nav-text">Script 10：对文件上锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-9"><span class="nav-number">11.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-9"><span class="nav-number">11.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-9"><span class="nav-number">11.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-9"><span class="nav-number">11.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-11%EF%BC%9AANSI-%E9%A2%9C%E8%89%B2%E5%BA%8F%E5%88%97"><span class="nav-number">12.</span> <span class="nav-text">Script 11：ANSI 颜色序列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-10"><span class="nav-number">12.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-10"><span class="nav-number">12.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-10"><span class="nav-number">12.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-10"><span class="nav-number">12.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-12%EF%BC%9A%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA-Shell-%E8%84%9A%E6%9C%AC%E5%BA%93"><span class="nav-number">13.</span> <span class="nav-text">Script 12：构建一个 Shell 脚本库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-11"><span class="nav-number">13.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-11"><span class="nav-number">13.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-11"><span class="nav-number">13.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-11"><span class="nav-number">13.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Script-13%EF%BC%9A%E8%B0%83%E8%AF%95-Shell-%E8%84%9A%E6%9C%AC"><span class="nav-number">14.</span> <span class="nav-text">Script 13：调试 Shell 脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81-12"><span class="nav-number">14.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86-12"><span class="nav-number">14.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C-12"><span class="nav-number">14.3.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hacking-12"><span class="nav-number">14.4.</span> <span class="nav-text">Hacking</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fuchencong"
      src="/fuchencong.github.io/images/logo.jpeg">
  <p class="site-author-name" itemprop="name">fuchencong</p>
  <div class="site-description" itemprop="description">Having dreams is what makes life tolerable.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/fuchencong.github.io/archives/">
        
          <span class="site-state-item-count">162</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/fuchencong.github.io/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/fuchencong.github.io/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/fuchencong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fuchencong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fuchencong@163.com" title="E-Mail → mailto:fuchencong@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fuchencong</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/fuchencong.github.io/lib/anime.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/fuchencong.github.io/js/utils.js"></script>

<script src="/fuchencong.github.io/js/motion.js"></script>


<script src="/fuchencong.github.io/js/schemes/muse.js"></script>


<script src="/fuchencong.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
