<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/fuchencong.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/fuchencong.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/fuchencong.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/fuchencong.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/fuchencong.github.io/css/main.css">


<link rel="stylesheet" href="/fuchencong.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"fuchencong.github.io","root":"/fuchencong.github.io/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="网络行业新技术层出不穷，最近又学习了解了 P4。P4 思想诞生于 2013 年，距离现在时间也不是很长。作为一门新技术，其资料还比较少，主要集中在其官方网站和 github 主页。这篇文章是基于我个人理解所写的一篇关于 P4 的入门介绍。">
<meta property="og:type" content="article">
<meta property="og:title" content="Hello World in P4">
<meta property="og:url" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/index.html">
<meta property="og:site_name" content="fuchencong">
<meta property="og:description" content="网络行业新技术层出不穷，最近又学习了解了 P4。P4 思想诞生于 2013 年，距离现在时间也不是很长。作为一门新技术，其资料还比较少，主要集中在其官方网站和 github 主页。这篇文章是基于我个人理解所写的一篇关于 P4 的入门介绍。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/switch_compare.png">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/p4_program_flow.png">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/psa.png">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/p4_runtime.png">
<meta property="og:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/switch_topo.png">
<meta property="article:published_time" content="2020-05-09T06:22:14.000Z">
<meta property="article:modified_time" content="2023-05-24T06:44:53.286Z">
<meta property="article:author" content="fuchencong">
<meta property="article:tag" content="P4">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/switch_compare.png">

<link rel="canonical" href="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Hello World in P4 | fuchencong</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/fuchencong.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">fuchencong</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The way I am</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/fuchencong.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/fuchencong.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/fuchencong.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/fuchencong.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/fuchencong.github.io/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://fuchencong.github.io/fuchencong.github.io/2020/05/09/hello-world-in-p4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/fuchencong.github.io/images/logo.jpeg">
      <meta itemprop="name" content="fuchencong">
      <meta itemprop="description" content="Having dreams is what makes life tolerable.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fuchencong">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hello World in P4
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-09 14:22:14" itemprop="dateCreated datePublished" datetime="2020-05-09T14:22:14+08:00">2020-05-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/fuchencong.github.io/categories/Network/" itemprop="url" rel="index"><span itemprop="name">Network</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>网络行业新技术层出不穷，最近又学习了解了 P4。P4 思想诞生于 2013 年，距离现在时间也不是很长。作为一门新技术，其资料还比较少，主要集中在其官方网站和 github 主页。这篇文章是基于我个人理解所写的一篇关于 P4 的入门介绍。</p>
<span id="more"></span>

<h2 id="P4-概述"><a href="#P4-概述" class="headerlink" title="P4 概述"></a>P4 概述</h2><h3 id="P4-是什么"><a href="#P4-是什么" class="headerlink" title="P4 是什么"></a>P4 是什么</h3><p>P4 是一种特定领域（domain-specific）的编程语言，用于描述可编程的转发设备如何处理报文，可编程的转发设备可以是交换芯片 ASIC、FPGA、网络接口卡、软件交换机等等。P4 的全名是 Programming Protocol-independent Packet Processors。P4 最初设计是用于可编程的交换机（尤指其所使用的交换芯片 ASIC），目前已经扩展到了许多设备。在 P4 中，使用术语 target 指代这些设备。</p>
<p>通常一个网络设备包含控制平面和数据平面。P4 被设计用于 target 的数据平面，即 P4 本身是用于对 target 的数据平面进行编程。下图展示了一个传统固定功能的交换机和一个 P4 可编程的交换机：</p>
<img src="/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/switch_compare.png" class="">

<p>在传统交换机中，交换芯片 ASIC 决定了其数据平面所支持的功能。而控制平面负责处理控制报文（例如路由协议包）、处理异步事件（例如接口 up&#x2F;down ）等，其最终目的是通过正确的设置 ASIC 的各种表项来控制其转发行为。因此交换芯片所支持的功能很大程度上就决定了交换机所能够支持的功能。</p>
<p>而 P4 可编程交换机则不同：数据平面的功能并不是固定的，而是由 P4 程序定义。数据平面本身不知道任何网络协议，其根据 P4 程序实现其功能。P4 是协议无关的，由程序员通过编程来使数据平面能够处理各种协议以及其他数据平面功能。</p>
<p>当然，这里其实说的有些绝对。例如，在传统交换机上，对于芯片不支持的协议或者不好实现的特性，可以将报文上送到 CPU 上，由软件进行处理（也就是我们通常所说的软转）。但其实这个例子也侧面说明了可编程的重要性：固定功能 ASIC 处理不了的特性交由运行在通用 CPU 上的软件处理。而现在 P4 要解决的问题就是对 ASIC 进行编程，使其能够灵活地处理新协议、新功能。</p>
<h3 id="P4-简史"><a href="#P4-简史" class="headerlink" title="P4 简史"></a>P4 简史</h3><p>P4 的想法最早诞生于 2013 年，由斯坦福大学的 Nick Mckeown 教授提出，在 2014 年发布了 P4 语言的第一个正式规范 ，称为P4_14。之后，在 2016 年发布了新规范 P4_16，是对 P4_14 的改进。可以看出 P4 语言使用发布年限作为其大版本的标识。</p>
<p>这里八卦一下 Nick Mckeown 教授，其不仅是一位超级学术大牛，而且也是 SDN 产业界的先驱，主导参与多个 SDN 开源项目：OpenFlow 协议、首个 SDN 控制器 NOX 等，创办了多个 SDN 创业公司：Nicira（已被 VMware 收购）、Barefoot Network（已被 Intel 收购）等。</p>
<h2 id="使用-P4-对-Target-编程"><a href="#使用-P4-对-Target-编程" class="headerlink" title="使用 P4 对 Target 编程"></a>使用 P4 对 Target 编程</h2><p>如下展示了使用 P4 对 target 进行编程的工作流：</p>
<img src="/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/p4_program_flow.png" class="">

<p>可以看到，网络设备的制造厂商需要提供以下组件：</p>
<ul>
<li>网络设备硬件（当然也可以是软件交换设备，例如 OVS、P4 项目自己实现的 simple_switch）</li>
<li>针对该设备的 P4 编译器（准确来说，编译器与 architecture 相关）</li>
<li>该设备所使用的 architecture 定义</li>
</ul>
<p>P4 是一门用于特定领域的编程语言，它被设计用于大量不同的 targets。而 P4 architecture 可以认为是 P4 程序和 target 之间的约定。因此每个设备厂商必须同时提供编译器以及该 target 所使用的 architecture 定义。P4 程序员针对特定的 architecture 编写程序。设备的 architecture 定义了该设备上一系列的 P4 可编程组件以及它们的外部数据平面接口。</p>
<p>通常来说，P4 程序不能跨 architecture 进行移植，但是如果不同 target 兼容同一种 architecture，那么在这些 target 上运行的 P4 程序是可以相互移植的。P4 社区希望针对不同形态的网络产品分别定义各自标准的 architecture，这样就可以提高 P4 程序的可移植性。目前针对交换机，P4 已经发布了 PSA 标准。</p>
<p>编译 P4 程序会产生两个交付件：</p>
<ul>
<li>数据平面配置，用于在数据平面实现由 P4 程序指定的转发逻辑。这个交付件可以是二进制的设备固件（例如针对 ASIC）；也可以是其他格式的文件，例如运行在 simple_switch 的 P4 程序交付件就是一个 JSON 文件</li>
<li>API，用于控制平面管理数据平面对象，例如对某个表进行表项添加&#x2F;删除</li>
</ul>
<h3 id="PSA"><a href="#PSA" class="headerlink" title="PSA"></a>PSA</h3><p>与 P14_16 语言一起发布的还有 PSA（Portable Switch Architecture），它是一种 target 体系结构，用于描述能够处理&#x2F;转发报文的多端口网络交换设备的公共能力。PSA 定义了一个类型库、externs 以及一系列的包路径（允许你编写程序控制报文在多端口交换设备中的流动）。只要遵守了 PSA 定义的 API 和各种行为，那么开发者编写的 P4 程序就可以进行跨设备移植，前提是这些设备兼容 PSA 体系结构。</p>
<p>在 PSA 官方介绍中，PSA 与 P14_16 语言的关系类似于 C 语言标准库与 C 语言的关系。个人认为这有两个含义：</p>
<ul>
<li>使用 PSA 体系结构，可以更加容易地构造出自己的交换机 target</li>
<li>如果你的 target 遵从 PSA 体系结构，P4 程序员编写的针对 PSA 体系结构的 P4 程序就可以轻易地运行在你的 target 上</li>
</ul>
<p>PSA 体系结构中的部分内容和网络交换机相关，因此如果存在另外一种 architecture（假设是 Portable NIC Architecture），那么新体系结构的这部分内容可能就和 PSA 的相应部分完全不同。</p>
<p>PSA 模型定义了 6 个 P4 可编程的 block 和 2 个固定功能的 block。可编程 block 的行为由 P4 程序指定。PRE（The Packet buffer and Replication Engine）以及 BQE（Buffer Queuing Engine）是与 target 相关的功能块，其通常是由一系列固定动作组成：</p>
<img src="/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/psa.png" class="">

<h2 id="P4-语言核心抽象"><a href="#P4-语言核心抽象" class="headerlink" title="P4 语言核心抽象"></a>P4 语言核心抽象</h2><p>为了对网络设备的转发行为进行适当建模，P4 语言定义了如下核心概念：</p>
<ul>
<li>Header types：定义了每个报文中各个报头的格式（所包含的字段和它们的大小）</li>
<li>Parsers：描述如何处理所收到报文的包头，这包括包头的解析顺序，从报文中要提取的包头和字段等</li>
<li>Tables：将用户定义的 key 和 action 进行关联。P4 的 Tables 对传统的二层交换表进行了泛化，可以用于实现路由表、flow 查找表和用户自定义类型的表</li>
<li>Actions：描述如何处理包头的字段以及元数据。Actions 可以包含由控制平面在运行时提供的数据</li>
<li>Match-action units：执行以下动作序列<ul>
<li>根据包头字段或者元数据构建查找 key</li>
<li>使用构建的查找 key 在 table 中执行查找，选择一个 action 执行（包括该 action 所包含的数据）</li>
<li>执行该动作</li>
</ul>
</li>
<li>Control flow：描述在某个 target 上包处理的流程，这包括处理顺序（通常与报文相关）以及要执行的 match-actions。包重组（Deparse）也可以通过 Control flow 实现</li>
<li>Extern objects：体系结构相关的组件，可以由 P4 程序通过定义明确的 API 来调用</li>
<li>User-defined metadata：与每个报文相关联的用户自定义数据结构</li>
<li>Intrinsic metadata：与每个报文相关联的由体系结构提供的元数据，例如接收报文的端口号</li>
</ul>
<p>可以看到，P4 语言根本不对协议做任何假设，而是通过提供这些语言抽象，让你能够编写程序处理各种网络协议，这也是 P4 核心思想之一。</p>
<h2 id="P4-项目组件"><a href="#P4-项目组件" class="headerlink" title="P4 项目组件"></a>P4 项目组件</h2><p>P4 是个开源项目，其 github 上包含多个子项目，这里列举出几个重要的子项目，通过介绍这些子项目以及这些子项目想要解决的问题，可以进一步加深对网络的理解。</p>
<h3 id="p4c"><a href="#p4c" class="headerlink" title="p4c"></a>p4c</h3><p>P4 是一种编程语言，而编程语言的实体存在就是编译器（解释型语言需要解释器）。p4c 就是 P4 语言的参考编译器。上文讲过，编译器是和 target 相关的，由网络设备制造厂商提供，那为什么还需要 p4c 呢？</p>
<p>p4c 至少存在两个重要用途：</p>
<ul>
<li>p4c 编译器的前端代码、中端代码可以被复用，vendor 只需要实现自己的编译器后端</li>
<li>p4c 自己实现的编译器后端。p4c-bm2-ss 用于编译运行在 p4 bmv2 simpe_switch 软件交换机上的 P4 程序</li>
</ul>
<h3 id="bmv2"><a href="#bmv2" class="headerlink" title="bmv2"></a>bmv2</h3><p>可以简单地认为，bmv2（Behavior Model Version 2）是 P4 项目实现的一个 P4 可编程软件交换机。bmv2 并不是一个产品质量级交换机，它只是用于开发人员开发、测试、调试 P4 程序（毕竟不是人人都有支持 P4 可编程的硬件设备）。</p>
<p>但 bmv2 项目又不仅只提供一个软件交换机，它是一套框架，通过它开发人员可以实现自己的软件交换机体系结构。因此目前 bmv2 已经提供了几个 target 变体：</p>
<ul>
<li>simple_switch：一个 P4 可编程软件交换机，可以运行在通用 CPU 上（Intel&#x2F;AMD 等）。它遵循 P4_14 语言规范，在 P4_16 中也就是遵循 v1model 体系结构</li>
<li>simple_switch_grpc：基于 simple_switch，但是其可以接受来自控制器的 TCP 连接，该连接中的控制消息由 P4Runtime 规范制定</li>
<li>psa_switch：类似于 simple_switch，只不过在 P4_16 中发布了 PSA 体系结构，而 psa_switch 就是以 PSA 为体系结构，而不再是 v1model</li>
</ul>
<h3 id="p4runtime"><a href="#p4runtime" class="headerlink" title="p4runtime"></a>p4runtime</h3><p>P4 是用于对数据平面进行编程的语言，它定义了数据平面所支持的功能。但是数据平面仍然需要在运行时接收控制平面下发的控制信息，以指导数据平面对现网实现正确的转发行为。而 P4Runtime 就是一套控制平面规范，用于控制网络设备的转发平面。</p>
<p>传统网络设备使用芯片厂商提供的 SDK 来操作 ASIC，网络设备内的控制平面通过内部 IPC 机制将控制信息下发到设备的驱动程序，驱动程序进而使用 ASIC 厂商提供的 SDK 来设置 ASIC。整个过程完全是厂商私有的、非公开的、且与 ASIC 硬件强相关的。随着 SDN 概念的兴起，其核心思想是控制平面与转发平面的分离，网络设备的控制平面可以不再位于网络设备内了，而是由集中式的 SDN 控制器进行控制，控制平面与转发平面也强调使用统一的标准协议（例如 OpenFlow）进行通信，而不再是设备厂商私有的 IPC 机制以及芯片厂商的 SDK 了。而 P4Runtime 就是想成为控制平面与转发平面通信的标准机制（OpenFlow&#x2F;SAI 是其当前的竞争者）。</p>
<p>P4Runtime 使用 Google 的 Protobuf 定义通信 API，使用 gRPC 作为通信机制，然后又通过一个名为 PI 的项目实现了 P4Runtime Server（运行在数据平面），这个过程的示意图如下：</p>
<img src="/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/p4_runtime.png" class="">

<h2 id="实践-P4"><a href="#实践-P4" class="headerlink" title="实践 P4"></a>实践 P4</h2><h3 id="开发环境搭建"><a href="#开发环境搭建" class="headerlink" title="开发环境搭建"></a>开发环境搭建</h3><p>通过上面的介绍，其实我们可以搭建一个非常复杂的 SDN P4 测试环境，整个网络栈都可以采用开源组件，例如：</p>
<ul>
<li>使用 ONOS 作为控制器</li>
<li>使用 P4Runtime 作为南向接口</li>
<li>使用 bmv2 模拟 P4 可编程数据平面</li>
<li>自行编写 P4 程序，定义 bmv2 的转发行为</li>
<li>使用 p4c 编译 P4 程序，将其作为 bmv2 的输入</li>
<li>使用 mininet 构建仿真网络拓扑</li>
</ul>
<p>但是既然本篇文章是 P4 的 <code>Hello World</code>，那么还是从一个比较简单的例子入手，该简易程序只处理以太封装的 IPv4 报文，并对 IPv4 目的地址执行最长匹配，以实现简单三层转发行为。想要实现该简单示例，至少需要在系统中安装 p4c、bmv2 及其相关依赖。</p>
<p>这里我用了一个偷懒的方法，在网络上找到了一个 P4 社区提供的虚拟机镜像，用虚拟机软件直接启动该虚拟机镜像即可，一切所需软件皆以就绪：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ <span class="built_in">whoami</span></span><br><span class="line">p4</span><br><span class="line">p4@p4:~$ <span class="built_in">uname</span> -a</span><br><span class="line">Linux p4 4.4.0-142-generic <span class="comment">#168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">p4@p4:~$ <span class="built_in">which</span> p4c</span><br><span class="line">/usr/local/bin/p4c</span><br><span class="line">p4@p4:~$ <span class="built_in">which</span> simple_switch</span><br><span class="line">/usr/local/bin/simple_switch</span><br></pre></td></tr></table></figure>

<h3 id="编写-P4-程序"><a href="#编写-P4-程序" class="headerlink" title="编写 P4 程序"></a>编写 P4 程序</h3><p>这里直接 copy 了 P4 官方 Tutorial 里提供的实例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;core.p4&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;v1model.p4&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> bit&lt;<span class="number">48</span>&gt; EthernetAddress;</span><br><span class="line"><span class="keyword">typedef</span> bit&lt;<span class="number">32</span>&gt; IPv4Address;</span><br><span class="line"></span><br><span class="line">header <span class="type">ethernet_t</span> &#123;</span><br><span class="line">    EthernetAddress dst_addr;</span><br><span class="line">    EthernetAddress src_addr;</span><br><span class="line">    bit&lt;<span class="number">16</span>&gt;         ether_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header <span class="type">ipv4_t</span> &#123;</span><br><span class="line">    bit&lt;<span class="number">4</span>&gt;      version;</span><br><span class="line">    bit&lt;<span class="number">4</span>&gt;      ihl;</span><br><span class="line">    bit&lt;<span class="number">8</span>&gt;      diffserv;</span><br><span class="line">    bit&lt;<span class="number">16</span>&gt;     total_len;</span><br><span class="line">    bit&lt;<span class="number">16</span>&gt;     identification;</span><br><span class="line">    bit&lt;<span class="number">3</span>&gt;      flags;</span><br><span class="line">    bit&lt;<span class="number">13</span>&gt;     frag_offset;</span><br><span class="line">    bit&lt;<span class="number">8</span>&gt;      ttl;</span><br><span class="line">    bit&lt;<span class="number">8</span>&gt;      protocol;</span><br><span class="line">    bit&lt;<span class="number">16</span>&gt;     hdr_checksum;</span><br><span class="line">    IPv4Address src_addr;</span><br><span class="line">    IPv4Address dst_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">headers_t</span> &#123;</span></span><br><span class="line">    <span class="type">ethernet_t</span> ethernet;</span><br><span class="line">    <span class="type">ipv4_t</span>     ipv4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">metadata_t</span> &#123;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">error &#123;</span><br><span class="line">    IPv4IncorrectVersion,</span><br><span class="line">    IPv4OptionsNotSupported</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parser <span class="title function_">my_parser</span><span class="params">(packet_in packet,</span></span><br><span class="line"><span class="params">                out <span class="type">headers_t</span> hd,</span></span><br><span class="line"><span class="params">                inout <span class="type">metadata_t</span> meta,</span></span><br><span class="line"><span class="params">                inout <span class="type">standard_metadata_t</span> standard_meta)</span></span><br><span class="line">&#123;</span><br><span class="line">    state start &#123;</span><br><span class="line">        packet.extract(hd.ethernet);</span><br><span class="line">        transition <span class="title function_">select</span><span class="params">(hd.ethernet.ether_type)</span> &#123;</span><br><span class="line">            <span class="number">0x0800</span>:  parse_ipv4;</span><br><span class="line">            <span class="keyword">default</span>: accept;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state parse_ipv4 &#123;</span><br><span class="line">        packet.extract(hd.ipv4);</span><br><span class="line">        verify(hd.ipv4.version == <span class="number">4</span>w4, error.IPv4IncorrectVersion);</span><br><span class="line">        verify(hd.ipv4.ihl == <span class="number">4</span>w5, error.IPv4OptionsNotSupported);</span><br><span class="line">        transition accept;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control <span class="title function_">my_deparser</span><span class="params">(packet_out packet,</span></span><br><span class="line"><span class="params">                   in <span class="type">headers_t</span> hdr)</span></span><br><span class="line">&#123;</span><br><span class="line">    apply &#123;</span><br><span class="line">        packet.emit(hdr.ethernet);</span><br><span class="line">        packet.emit(hdr.ipv4);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control <span class="title function_">my_verify_checksum</span><span class="params">(inout <span class="type">headers_t</span> hdr,</span></span><br><span class="line"><span class="params">                         inout <span class="type">metadata_t</span> meta)</span></span><br><span class="line">&#123;</span><br><span class="line">    apply &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control <span class="title function_">my_compute_checksum</span><span class="params">(inout <span class="type">headers_t</span> hdr,</span></span><br><span class="line"><span class="params">                          inout <span class="type">metadata_t</span> meta)</span></span><br><span class="line">&#123;</span><br><span class="line">    apply &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control <span class="title function_">my_ingress</span><span class="params">(inout <span class="type">headers_t</span> hdr,</span></span><br><span class="line"><span class="params">                  inout <span class="type">metadata_t</span> meta,</span></span><br><span class="line"><span class="params">                  inout <span class="type">standard_metadata_t</span> standard_metadata)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">bool</span> dropped = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    action <span class="title function_">drop_action</span><span class="params">()</span> &#123;</span><br><span class="line">        mark_to_drop(standard_metadata);</span><br><span class="line">        dropped = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    action <span class="title function_">to_port_action</span><span class="params">(bit&lt;<span class="number">9</span>&gt; port)</span> &#123;</span><br><span class="line">        hdr.ipv4.ttl = hdr.ipv4.ttl - <span class="number">1</span>;</span><br><span class="line">        standard_metadata.egress_spec = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    table ipv4_match &#123;</span><br><span class="line">        key = &#123;</span><br><span class="line">            hdr.ipv4.dst_addr: lpm;</span><br><span class="line">        &#125;</span><br><span class="line">        actions = &#123;</span><br><span class="line">            drop_action;</span><br><span class="line">            to_port_action;</span><br><span class="line">        &#125;</span><br><span class="line">        size = <span class="number">1024</span>;</span><br><span class="line">        default_action = drop_action;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    apply &#123;</span><br><span class="line">        ipv4_match.apply();</span><br><span class="line">        <span class="keyword">if</span> (dropped) <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">control <span class="title function_">my_egress</span><span class="params">(inout <span class="type">headers_t</span> hdr,</span></span><br><span class="line"><span class="params">                 inout <span class="type">metadata_t</span> meta,</span></span><br><span class="line"><span class="params">                 inout <span class="type">standard_metadata_t</span> standard_metadata)</span></span><br><span class="line">&#123;</span><br><span class="line">    apply &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">V1Switch(my_parser(),</span><br><span class="line">         my_verify_checksum(),</span><br><span class="line">         my_ingress(),</span><br><span class="line">         my_egress(),</span><br><span class="line">         my_compute_checksum(),</span><br><span class="line">         my_deparser()) main;</span><br></pre></td></tr></table></figure>

<p>简单解释一下该程序：</p>
<ul>
<li>在 parser 这个可编程 block 里定义了自己的处理逻辑，只是简单的解析出以太头和 IPv4 头，并对 IPv4 头做简单的字段检查</li>
<li>在 ingress 这个可编程 block 里定义了自己的处理逻辑，对 IPv4 目的地址执行 LPM（最长前缀匹配）</li>
<li>在 deparser 这个可编程 block 里定义了自己的处理逻辑，简单重组以太头和 IPv4 头</li>
<li>最后使用自己的定义实例化了 V1Switch</li>
</ul>
<h3 id="编译该-P4-程序"><a href="#编译该-P4-程序" class="headerlink" title="编译该 P4 程序"></a>编译该 P4 程序</h3><p>使用如下命令编译该 P4 程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p4c -b bmv2 test.p4 -o test.bmv2</span><br></pre></td></tr></table></figure>

<ul>
<li>-b：指定 target</li>
<li>-o：指定输出路径</li>
</ul>
<p>如果编译成功，可以在当前目录的 test.bmv2 目录下找到名为 test.json 的交付件，这就是接下来要运行在 simple_switch 软件交换机的 程序。</p>
<h3 id="构建网络拓扑"><a href="#构建网络拓扑" class="headerlink" title="构建网络拓扑"></a>构建网络拓扑</h3><p>我们将构建如下的网络拓扑，其中交换机就是我们的 P4 可编程 simple_switch，同时使用 Linux 的 veth 为该 switch 创建以太接口：</p>
<img src="/fuchencong.github.io/2020/05/09/hello-world-in-p4/images/switch_topo.png" class="">

<ul>
<li>创建虚拟 veth pair 接口，同时禁用该接口上的 IPv6，防止对后面测试产生干扰</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo ip <span class="built_in">link</span> add name veth0 <span class="built_in">type</span> veth peer name veth1</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth0 up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth1 up</span><br><span class="line">sudo sysctl net.ipv6.conf.veth0.disable_ipv6=1</span><br><span class="line">sudo sysctl net.ipv6.conf.veth1.disable_ipv6=1</span><br><span class="line"></span><br><span class="line">sudo ip <span class="built_in">link</span> add name veth2 <span class="built_in">type</span> veth peer name veth3</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth2 up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth3 up</span><br><span class="line">sudo sysctl net.ipv6.conf.veth2.disable_ipv6=1</span><br><span class="line">sudo sysctl net.ipv6.conf.veth3.disable_ipv6=1</span><br><span class="line"></span><br><span class="line">sudo ip <span class="built_in">link</span> add name veth4 <span class="built_in">type</span> veth peer name veth5</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth4 up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth5 up</span><br><span class="line">sudo sysctl net.ipv6.conf.veth4.disable_ipv6=1</span><br><span class="line">sudo sysctl net.ipv6.conf.veth5.disable_ipv6=1</span><br></pre></td></tr></table></figure>

<ul>
<li>启动 simple_switch 交换机</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~/test$ sudo simple_switch --interface 0@veth0 --interface 1@veth2 --interface 2@veth4 test.bmv2/test.json &amp;</span><br><span class="line">[1] 4060</span><br><span class="line">p4@p4:~/test$ Calling target program-options parser</span><br><span class="line">Adding interface veth0 as port 0</span><br><span class="line">Adding interface veth2 as port 1</span><br><span class="line">Adding interface veth4 as port 2</span><br></pre></td></tr></table></figure>

<h3 id="向交换机的路由表中下发路由"><a href="#向交换机的路由表中下发路由" class="headerlink" title="向交换机的路由表中下发路由"></a>向交换机的路由表中下发路由</h3><p>接下来将通过 simple_switch_CLI 程序来控制该 P4 软件交换机</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~/test$ simple_switch_CLI</span><br><span class="line">Obtaining JSON from switch...</span><br><span class="line">Done</span><br><span class="line">Control utility <span class="keyword">for</span> runtime P4 table manipulation</span><br><span class="line">RuntimeCmd:</span><br></pre></td></tr></table></figure>

<p>使用 show tables 命令查看当前所有表，使用 table_info 命令查看指定表的具体信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">RuntimeCmd: show_tables</span><br><span class="line">my_ingress.ipv4_match          [implementation=None, mk=ipv4.dst_addr(lpm, 32)]</span><br><span class="line">tbl_act                        [implementation=None, mk=]</span><br><span class="line">RuntimeCmd: table_info ipv4_match</span><br><span class="line">my_ingress.ipv4_match          [implementation=None, mk=ipv4.dst_addr(lpm, 32)]</span><br><span class="line">********************************************************************************</span><br><span class="line">my_ingress.drop_action         []</span><br><span class="line">my_ingress.to_port_action      [port(9)]</span><br></pre></td></tr></table></figure>

<p>接下来我本人就是控制平面，将使用 table_add 命令向交换机添加路由，这里假设：</p>
<ul>
<li>port 0（veth 0）连接 10.10.0.0&#x2F;16 网段</li>
<li>port 1（veth 2）连接 20.20.0.0&#x2F;16 网段</li>
<li>port 2（veth 4）连接 30.30.0.0&#x2F;16 网段</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RuntimeCmd: table_add ipv4_match to_port_action 10.10.0.0/16 =&gt; 0</span><br><span class="line">Adding entry to lpm match table ipv4_match</span><br><span class="line">match key:           LPM-0a:0a:00:00/16</span><br><span class="line">action:              to_port_action</span><br><span class="line">runtime data:        00:00</span><br><span class="line">Entry has been added with handle 0</span><br><span class="line">RuntimeCmd: table_add ipv4_match to_port_action 20.20.0.0/16 =&gt; 1</span><br><span class="line">Adding entry to lpm match table ipv4_match</span><br><span class="line">match key:           LPM-14:14:00:00/16</span><br><span class="line">action:              to_port_action</span><br><span class="line">runtime data:        00:01</span><br><span class="line">Entry has been added with handle 1</span><br><span class="line">RuntimeCmd: table_add ipv4_match to_port_action 30.30.0.0/16 =&gt; 2</span><br><span class="line">Adding entry to lpm match table ipv4_match</span><br><span class="line">match key:           LPM-1e:1e:00:00/16</span><br><span class="line">action:              to_port_action</span><br><span class="line">runtime data:        00:02</span><br><span class="line">Entry has been added with handle 2</span><br></pre></td></tr></table></figure>

<p>使用 table_dump 确认添加的表项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">RuntimeCmd: table_dump ipv4_match</span><br><span class="line">==========</span><br><span class="line">TABLE ENTRIES</span><br><span class="line">**********</span><br><span class="line">Dumping entry 0x0</span><br><span class="line">Match key:</span><br><span class="line">* ipv4.dst_addr       : LPM       0a0a0000/16</span><br><span class="line">Action entry: my_ingress.to_port_action - 00</span><br><span class="line">**********</span><br><span class="line">Dumping entry 0x1</span><br><span class="line">Match key:</span><br><span class="line">* ipv4.dst_addr       : LPM       14140000/16</span><br><span class="line">Action entry: my_ingress.to_port_action - 01</span><br><span class="line">**********</span><br><span class="line">Dumping entry 0x2</span><br><span class="line">Match key:</span><br><span class="line">* ipv4.dst_addr       : LPM       1e1e0000/16</span><br><span class="line">Action entry: my_ingress.to_port_action - 02</span><br><span class="line">==========</span><br><span class="line">Dumping default entry</span><br><span class="line">Action entry: my_ingress.drop_action -</span><br><span class="line">==========</span><br></pre></td></tr></table></figure>

<h3 id="测试交换机的三层转发"><a href="#测试交换机的三层转发" class="headerlink" title="测试交换机的三层转发"></a>测试交换机的三层转发</h3><p>接下来我们将使用 scapy 工具从 veth1 注入报文，然后分别在 veth3 和 veth 5 上使用 tcpdump 抓包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ sudo scapy</span><br><span class="line">INFO: Can<span class="string">&#x27;t import python gnuplot wrapper . Won&#x27;</span>t be able to plot.</span><br><span class="line">INFO: Can<span class="string">&#x27;t import PyX. Won&#x27;</span>t be able to use psdump() or pdfdump().</span><br><span class="line">WARNING: No route found <span class="keyword">for</span> IPv6 destination :: (no default route?)</span><br><span class="line">INFO: Can<span class="string">&#x27;t import python Crypto lib. Won&#x27;</span>t be able to decrypt WEP.</span><br><span class="line">INFO: Can<span class="string">&#x27;t import python Crypto lib. Disabled certificate manipulation tools</span></span><br><span class="line"><span class="string">Welcome to Scapy (2.2.0)</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ sudo tcpdump -n -i veth3</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on veth3, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ sudo tcpdump -n -i veth5</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on veth5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>

<ul>
<li>从 veth1 注入目的地为 20.20.0.1 的报文，veth 3 收到报文，而 veth 5 没有收到任何报文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p = Ether()/IP(dst=<span class="string">&quot;20.20.0.1&quot;</span>)/UDP()</span><br><span class="line">&gt;&gt;&gt; sendp(p, iface=<span class="string">&quot;veth1&quot;</span>)</span><br><span class="line">.</span><br><span class="line">Sent 1 packets.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ sudo tcpdump -n -i veth3</span><br><span class="line">18:12:18.435592 IP 192.168.204.145.53 &gt; 20.20.0.1.53: [|domain]</span><br></pre></td></tr></table></figure>

<ul>
<li>从 veth1 注入目的地为 30.30.0.1 的报文，veth 5 收到报文，而 veth 3 没有收到任何报文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p = Ether()/IP(dst=<span class="string">&quot;30.30.0.1&quot;</span>)/UDP()</span><br><span class="line">&gt;&gt;&gt; sendp(p, iface=<span class="string">&quot;veth1&quot;</span>)</span><br><span class="line">.</span><br><span class="line">Sent 1 packets.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p4@p4:~$ sudo tcpdump -n -i veth5</span><br><span class="line">18:13:56.702667 IP 192.168.204.145.53 &gt; 30.30.0.1.53: [|domain]</span><br></pre></td></tr></table></figure>

<p>可以看到，运行着由我们编写的 P4 程序的 simple_switch 按照预期执行了 LPM 转发。假设我们想要改变该交换机的行为，例如执行最短前缀匹配，我们只需要重新编写我们的 P4 程序，然后让 simple_switch 重新加载我们的 P4 程序，该 simple_switch 就能按照最短前缀匹配执行 IPv4 转发了。</p>
<p>这就是 P4 的魅力！</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://p4.org/p4-spec/docs/P4-16-v1.2.0.html">P4_16 语言规范</a><br><a target="_blank" rel="noopener" href="https://p4.org/p4-spec/docs/PSA-v1.1.0.html">PSA</a><br><a target="_blank" rel="noopener" href="https://github.com/p4lang/tutorials">P4 Tutorial</a><br><a target="_blank" rel="noopener" href="https://github.com/p4lang/tutorials">P4 Get Started</a><br><a target="_blank" rel="noopener" href="https://github.com/p4lang/tutorials">P4 Github</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/fuchencong.github.io/tags/P4/" rel="tag"># P4</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2020/05/13/pro-git-01/" rel="prev" title="Pro Git（1）：Git 起步">
      <i class="fa fa-chevron-left"></i> Pro Git（1）：Git 起步
    </a></div>
      <div class="post-nav-item">
    <a href="/fuchencong.github.io/2019/11/22/my-life-03/" rel="next" title="光谷买房记">
      光谷买房记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#P4-%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">P4 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#P4-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.1.</span> <span class="nav-text">P4 是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#P4-%E7%AE%80%E5%8F%B2"><span class="nav-number">1.2.</span> <span class="nav-text">P4 简史</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-P4-%E5%AF%B9-Target-%E7%BC%96%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">使用 P4 对 Target 编程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PSA"><span class="nav-number">2.1.</span> <span class="nav-text">PSA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#P4-%E8%AF%AD%E8%A8%80%E6%A0%B8%E5%BF%83%E6%8A%BD%E8%B1%A1"><span class="nav-number">3.</span> <span class="nav-text">P4 语言核心抽象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#P4-%E9%A1%B9%E7%9B%AE%E7%BB%84%E4%BB%B6"><span class="nav-number">4.</span> <span class="nav-text">P4 项目组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#p4c"><span class="nav-number">4.1.</span> <span class="nav-text">p4c</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bmv2"><span class="nav-number">4.2.</span> <span class="nav-text">bmv2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p4runtime"><span class="nav-number">4.3.</span> <span class="nav-text">p4runtime</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-P4"><span class="nav-number">5.</span> <span class="nav-text">实践 P4</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">5.1.</span> <span class="nav-text">开发环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99-P4-%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.2.</span> <span class="nav-text">编写 P4 程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E8%AF%A5-P4-%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.3.</span> <span class="nav-text">编译该 P4 程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="nav-number">5.4.</span> <span class="nav-text">构建网络拓扑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A1%A8%E4%B8%AD%E4%B8%8B%E5%8F%91%E8%B7%AF%E7%94%B1"><span class="nav-number">5.5.</span> <span class="nav-text">向交换机的路由表中下发路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%9A%84%E4%B8%89%E5%B1%82%E8%BD%AC%E5%8F%91"><span class="nav-number">5.6.</span> <span class="nav-text">测试交换机的三层转发</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="fuchencong"
      src="/fuchencong.github.io/images/logo.jpeg">
  <p class="site-author-name" itemprop="name">fuchencong</p>
  <div class="site-description" itemprop="description">Having dreams is what makes life tolerable.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/fuchencong.github.io/archives/">
        
          <span class="site-state-item-count">145</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/fuchencong.github.io/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/fuchencong.github.io/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/fuchencong" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fuchencong" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:fuchencong@163.com" title="E-Mail → mailto:fuchencong@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fuchencong</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/fuchencong.github.io/lib/anime.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/fuchencong.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/fuchencong.github.io/js/utils.js"></script>

<script src="/fuchencong.github.io/js/motion.js"></script>


<script src="/fuchencong.github.io/js/schemes/muse.js"></script>


<script src="/fuchencong.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
